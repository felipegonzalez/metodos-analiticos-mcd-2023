<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Métodos analíticos - 9&nbsp; Aplicaciones de modelos de espacio de estados</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./99-referencias.html" rel="next">
<link href="./08-modelos-1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Aplicaciones de modelos de espacio de estados</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Métodos analíticos</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Temario y referencias</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción (Parte 1)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-modelos-graficos.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Modelos gráficos probabilísticos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-modelos-causales.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelos causales e inferencia</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-experimentos.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Experimentos y controles</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-contrafactuales.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Contrafactuales</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-exp-naturales.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Otros métodos para inferencia causal</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-intro-series.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Análisis de series de tiempo</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-modelos-1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modelos de espacio de estados</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-aplicaciones-espacio-estados.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Aplicaciones de modelos de espacio de estados</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-referencias.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./apendice-1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Apéndice 1</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#pronósticos" id="toc-pronósticos" class="nav-link active" data-scroll-target="#pronósticos"><span class="toc-section-number">9.1</span>  Pronósticos</a></li>
  <li><a href="#análisis-de-datos-diarios" id="toc-análisis-de-datos-diarios" class="nav-link" data-scroll-target="#análisis-de-datos-diarios"><span class="toc-section-number">9.2</span>  Análisis de datos diarios</a>
  <ul class="collapse">
  <li><a href="#estacionalidad-trigonométrica" id="toc-estacionalidad-trigonométrica" class="nav-link" data-scroll-target="#estacionalidad-trigonométrica">Estacionalidad trigonométrica</a></li>
  <li><a href="#días-de-asueto" id="toc-días-de-asueto" class="nav-link" data-scroll-target="#días-de-asueto"><span class="toc-section-number">9.2.1</span>  Días de asueto</a></li>
  </ul></li>
  <li><a href="#nowcasting-y-uso-de-covariables" id="toc-nowcasting-y-uso-de-covariables" class="nav-link" data-scroll-target="#nowcasting-y-uso-de-covariables"><span class="toc-section-number">9.3</span>  Nowcasting y uso de covariables</a></li>
  <li><a href="#agregación-de-encuestas" id="toc-agregación-de-encuestas" class="nav-link" data-scroll-target="#agregación-de-encuestas"><span class="toc-section-number">9.4</span>  Agregación de encuestas</a></li>
  <li><a href="#impacto-causal" id="toc-impacto-causal" class="nav-link" data-scroll-target="#impacto-causal"><span class="toc-section-number">9.5</span>  Impacto causal</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Aplicaciones de modelos de espacio de estados</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>locale <span class="ot">&lt;-</span> <span class="fu">Sys.setlocale</span>(<span class="st">"LC_TIME"</span>, <span class="st">"es_ES.UTF-8"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpp3)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_light</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="pronósticos" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="pronósticos"><span class="header-section-number">9.1</span> Pronósticos</h2>
<p>Consideramos un ejemplo de <span class="citation" data-cites="hyndman2014">Hyndman y Athanasopoulos (<a href="99-referencias.html#ref-hyndman2014" role="doc-biblioref">2014</a>)</span> <a href="https://otexts.com/fpp3/seasonal-arima.html">en la esta sección</a>, donde buscamos hacer pronósticos de empleo en Estados Unidos. Consideramos los datos de entretenimiento y hospitalidad:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ent_hosp_tbl <span class="ot">&lt;-</span> <span class="fu">filter</span>(us_employment, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  Title <span class="sc">==</span> <span class="st">"Leisure and Hospitality"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter_index</span>(<span class="st">"2000-01"</span> <span class="sc">~</span> . )</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ent_hosp_ts <span class="ot">&lt;-</span> ent_hosp_tbl <span class="sc">|&gt;</span> <span class="fu">as.ts</span>(Employed)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#ent_hosp_ts &lt;- log(ent_hosp_ts)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ent_hosp_tbl, Employed)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Intentaremos usar varios modelos, incluso algunos que claramente no son correctos:</p>
<ol type="1">
<li>Nivel local</li>
<li>Nivel local y tendencia</li>
<li>Nivel local con estacionalidad (12 meses)</li>
<li>Nivel local con tendencia y estacionalidad (12 meses)</li>
<li>Nivel semilocal con tendencia y estacionalidad</li>
<li>Nivel semilocal con tendencia, estacionalidad, y una componente autoregresiva.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bsts)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">998</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#inicial_nivel &lt;- NormalPrior(11000, 1500, initial.value = 11000)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>mod_spec_1 <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>mod_spec_2 <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>mod_spec_3 <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>mod_spec_4 <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts) </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>mod_spec_5 <span class="ot">&lt;-</span> <span class="fu">AddSemilocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts) </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>mod_spec_6 <span class="ot">&lt;-</span> <span class="fu">AddSemilocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddAr</span>(<span class="at">lags =</span> <span class="dv">2</span>, <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>specs <span class="ot">&lt;-</span> <span class="fu">list</span>(mod_spec_1, mod_spec_2, mod_spec_3, mod_spec_4, mod_spec_5, mod_spec_6)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>ajustes <span class="ot">&lt;-</span> <span class="fu">map</span>(specs, <span class="cf">function</span>(spec){</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bsts</span>(ent_hosp_ts, spec, <span class="at">niter =</span> <span class="dv">40000</span>, <span class="at">ping =</span> <span class="dv">10000</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Fri Apr 21 06:33:07 2023 =-=-=-=-=
=-=-=-=-= Iteration 10000 Fri Apr 21 06:33:20 2023 =-=-=-=-=
=-=-=-=-= Iteration 20000 Fri Apr 21 06:33:33 2023 =-=-=-=-=
=-=-=-=-= Iteration 30000 Fri Apr 21 06:33:46 2023 =-=-=-=-=
=-=-=-=-= Iteration 0 Fri Apr 21 06:33:59 2023 =-=-=-=-=
=-=-=-=-= Iteration 10000 Fri Apr 21 06:34:15 2023 =-=-=-=-=
=-=-=-=-= Iteration 20000 Fri Apr 21 06:34:30 2023 =-=-=-=-=
=-=-=-=-= Iteration 30000 Fri Apr 21 06:34:45 2023 =-=-=-=-=
=-=-=-=-= Iteration 0 Fri Apr 21 06:35:01 2023 =-=-=-=-=
=-=-=-=-= Iteration 10000 Fri Apr 21 06:35:35 2023 =-=-=-=-=
=-=-=-=-= Iteration 20000 Fri Apr 21 06:36:09 2023 =-=-=-=-=
=-=-=-=-= Iteration 30000 Fri Apr 21 06:36:44 2023 =-=-=-=-=
=-=-=-=-= Iteration 0 Fri Apr 21 06:37:18 2023 =-=-=-=-=
=-=-=-=-= Iteration 10000 Fri Apr 21 06:37:59 2023 =-=-=-=-=
=-=-=-=-= Iteration 20000 Fri Apr 21 06:38:39 2023 =-=-=-=-=
=-=-=-=-= Iteration 30000 Fri Apr 21 06:39:20 2023 =-=-=-=-=
=-=-=-=-= Iteration 0 Fri Apr 21 06:40:00 2023 =-=-=-=-=
=-=-=-=-= Iteration 10000 Fri Apr 21 06:40:41 2023 =-=-=-=-=
=-=-=-=-= Iteration 20000 Fri Apr 21 06:41:21 2023 =-=-=-=-=
=-=-=-=-= Iteration 30000 Fri Apr 21 06:42:02 2023 =-=-=-=-=
=-=-=-=-= Iteration 0 Fri Apr 21 06:42:42 2023 =-=-=-=-=
=-=-=-=-= Iteration 10000 Fri Apr 21 06:43:40 2023 =-=-=-=-=
=-=-=-=-= Iteration 20000 Fri Apr 21 06:44:38 2023 =-=-=-=-=
=-=-=-=-= Iteration 30000 Fri Apr 21 06:45:35 2023 =-=-=-=-=</code></pre>
</div>
</div>
<p>En primer lugar, podemos comparar las predicciones a un paso de cada modelo. En este caso, los modelos 3 y 4 son claramente superiores a 1 y 2 en desempeño a un paso. El mejor modelo en desempeño a un paso es el modelo 4, por la tendencia lineal de la serie.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CompareBstsModels</span>(ajustes, <span class="at">burn =</span> <span class="dv">20000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> ajustes[[<span class="dv">6</span>]]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ajuste, <span class="st">"components"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pred_errors_tbl <span class="ot">&lt;-</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bsts.prediction.errors</span>(ajuste, <span class="at">burn =</span> <span class="dv">20000</span>)<span class="sc">$</span>in.sample <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(ent_hosp_ts)) <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(t), <span class="at">names_to =</span> <span class="st">"sim"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span> </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">valor =</span> <span class="fu">mean</span>(valor)) <span class="sc">|&gt;</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> t)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if
`.name_repair` is omitted as of tibble 2.0.0.
ℹ Using compatibility `.name_repair`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filtramos a partir de 12 meses (mínimo requerido para</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># estimar estacionalidad):</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ACF</span>(pred_errors_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(t <span class="sc">&gt;</span> <span class="dv">12</span>), valor, <span class="at">lag_max =</span> <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ahora podemos hacer pronósticos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> ajustes[[<span class="dv">6</span>]]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">36</span>, <span class="at">burn =</span> <span class="dv">30000</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(pred)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos hacer también pronósticos agregados. Como tenemos simulaciones de los pronósticos, esto es fácil, incluyendo intervalos predictivos. En el siguiente ejemplo, hacemos un intervalo para la suma de los 36 meses que pronosticamos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>distribution <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000    36</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pred<span class="sc">$</span>distribution, <span class="dv">1</span>, sum) <span class="sc">|&gt;</span> <span class="fu">qplot</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `qplot()` was deprecated in ggplot2 3.4.0.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="384"></p>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Intervalo de 90% para el agregado:"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Intervalo de 90% para el agregado:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pred<span class="sc">$</span>distribution, <span class="dv">1</span>, sum) <span class="sc">|&gt;</span> <span class="fu">quantile</span>(<span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.50</span>, <span class="fl">0.95</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      5%      50%      95% 
600230.0 617269.0 634272.5 </code></pre>
</div>
</div>
</section>
<section id="análisis-de-datos-diarios" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="análisis-de-datos-diarios"><span class="header-section-number">9.2</span> Análisis de datos diarios</h2>
<p>Consideremos por ejemplo la siguiente serie de nacimientos por día en México (ver la sección de introducción de series de tiempo):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>natalidad_tbl <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"../datos/natalidad.rds"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(fecha) <span class="sc">|&gt;</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fecha <span class="sc">&gt;=</span> <span class="fu">ymd</span>(<span class="st">"2008-01-01"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nacimientos =</span> <span class="fu">log</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fecha_str, <span class="sc">-</span>n) <span class="sc">|&gt;</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> fecha)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> natalidad_tbl <span class="sc">|&gt;</span> <span class="fu">as.ts</span>(<span class="at">frequency =</span> <span class="fl">365.25</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">zoo</span>(natalidad_tbl<span class="sc">$</span>nacimientos, natalidad_tbl<span class="sc">$</span>fecha)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>natalidad_tbl <span class="ot">&lt;-</span> natalidad_tbl <span class="sc">|&gt;</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feb_29 =</span> <span class="fu">as.numeric</span>(<span class="fu">month</span>(fecha)<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">day</span>(fecha) <span class="sc">==</span> <span class="dv">29</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>feb_29 <span class="ot">&lt;-</span> natalidad_tbl<span class="sc">$</span>feb_29</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>mar_1_feb_29 <span class="ot">&lt;-</span> <span class="fu">lag</span>(feb_29, <span class="at">default =</span> <span class="dv">0</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En este caso, es necesario:</p>
<ul>
<li>Agregar estacionalidad con periodo de 7 días</li>
<li>Agregar estacionalidad con periodo de 1 año</li>
<li>Agregar efectos de días de asueto, incluyendo posibles efectos que no ocurren solamente el día en cuestión, sino en los “hombros” del día (unos días antes o después).</li>
</ul>
<p>La estacionalidad anual la modelamos con armónicos de periodo 365.25, es decir, con <span class="math inline">\(\lambda_j = 2\pi j /365.25\)</span>. Cada armónico agrega dos coeficientes al espacio de estados.</p>
<section id="estacionalidad-trigonométrica" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="estacionalidad-trigonométrica">Estacionalidad trigonométrica</h3>
<p>Supongamos que queremos modelar estacionalidad anual para datos mensuales usando armónicos. El primer armónico tiene un ciclo de 12 meses, así que ponemos <span class="math display">\[\lambda_1 = 2\pi /12 = \pi/6\]</span> Consideramos las funciones</p>
<p><span class="math display">\[f_1(t) = a\cos(\lambda_1 t) + b \sin(\lambda_1 t)\]</span></p>
<p>Con el tamaño de a y b se define la amplitud, y la fase depende de los tamaños relativos de <span class="math inline">\(a\)</span> y <span class="math inline">\(b\)</span>. Esto lo podemos ver, por ejemplo, notando que <span class="math inline">\(a\sin x + b\cos x = \sqrt{a^2 + b^2}\sin(x + \alpha)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>arm_1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">t=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">f_1 =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">cos</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>) <span class="sc">+</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fu">sin</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">t=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">f_1 =</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">cos</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>) <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">sin</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(arm_1, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> f_1, <span class="at">colour =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">13</span>, <span class="dv">25</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos considerar armónicos más altos. El siguiente es</p>
<p><span class="math display">\[f_2(t) = f_1(t) + a_2\cos(2\lambda_1 t) + b_2 \sin(2\lambda_1 t)\]</span> para obtener una funciones como las que siguen:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>arm_2 <span class="ot">&lt;-</span> arm_1 <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">f_2 =</span> f_1 <span class="sc">+</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">*</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(arm_2, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> f_2, <span class="at">colour =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">13</span>, <span class="dv">25</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y así sucesivamente. Cualquier función periodica puede aproximarse bien mediante una suma de cosenos y senos, siempre y cuando utilicemos suficientes armónicos.</p>
<p>Nota que en los ejemplos de arriba necesitamos dos coeficientes para cada armónico. La componente estacional del modelo podemos escribirla como (para estacionalidad constante):</p>
<p><span class="math display">\[\gamma_t = \sum_{j=1}^L (a_j \cos(\lambda_j t) + a^*_j \sin(\lambda_jt)).\]</span> Y hacemos estocásticas estas componentes sustituyendo <span class="math display">\[a_{j,t+1} = a_{j,t} + \omega_{j,t},  a^*_{j,t+1} = a^*_{j,t} + \omega^*_{j,t}\]</span> donde las <span class="math inline">\(\omega,\omega^*\)</span> son normales independientes con varianza <span class="math inline">\(\sigma_\omega^2\)</span>.</p>
<p>Esta es la forma más simple de agregar estacionalidad trigonométrica, pero tiene la desventaja de que los errores que agregamos se multiplican después por senos y cosenos, lo cual quiere decir que su efecto no es igual en diferentes partes del periodo. La otra forma más usual puedes verla en la ayuda de <em>AddTrig</em> de bsts o en la sección 3.2.1 de <span class="citation" data-cites="durbinkoopman">Durbin y Koopman (<a href="99-referencias.html#ref-durbinkoopman" role="doc-biblioref">2001</a>)</span>.</p>
<hr>
<p>Nuestra primera parte del modelo es entonces (donde podemos ajustar el número de frecuencias o armónicos que incluímos comparando los modelos producidos):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>modelo_natalidad_1 <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">7</span>, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddTrig</span>(<span class="at">period =</span> <span class="fl">365.25</span>, <span class="at">frequencies =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> y) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="días-de-asueto" class="level3" data-number="9.2.1">
<h3 data-number="9.2.1" class="anchored" data-anchor-id="días-de-asueto"><span class="header-section-number">9.2.1</span> Días de asueto</h3>
<p>Definiremos componentes para algunos de los días de asueto/especiales más importantes, considerando que su efecto puede ir más allá del día particular. En la versión estática, tenemos un coeficiente distinto para cada uno de esos días en la ventana que hayamos elegido:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>año_nuevo <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"NewYearsDay"</span>, <span class="at">days.before =</span> <span class="dv">2</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">days.after =</span> <span class="dv">4</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>navidad <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"Christmas"</span>, <span class="at">days.before =</span> <span class="dv">4</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">days.after =</span> <span class="dv">4</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>pascua <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"EasterSunday"</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days.after =</span> <span class="dv">5</span>, <span class="at">days.before =</span> <span class="dv">5</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>feb_14 <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"ValentinesDay"</span>, </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days.after =</span> <span class="dv">3</span>, <span class="at">days.before =</span> <span class="dv">3</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>halloween <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"Halloween"</span>, </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days.after =</span> <span class="dv">5</span>, <span class="at">days.before =</span> <span class="dv">4</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>sept_16 <span class="ot">&lt;-</span> <span class="fu">FixedDateHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"Independencia"</span>, </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">month =</span> <span class="st">"September"</span>, <span class="at">day =</span> <span class="dv">16</span>, <span class="at">days.before =</span> <span class="dv">3</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">days.after =</span> <span class="dv">3</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y nuestro modelo es entonces, agregando también un coeficiente para febrero 29 y marzo 1 cuando sigue de 29 de febrero:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>modelo_natalidad <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">7</span>, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddTrig</span>(<span class="at">period =</span> <span class="fl">365.25</span>, <span class="at">frequencies =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> año_nuevo, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> navidad, <span class="at">y =</span> y,) <span class="sc">|&gt;</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> pascua, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> feb_14, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> halloween, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> sept_16, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddDynamicRegression</span>(y <span class="sc">~</span> feb_29 <span class="sc">+</span> mar_1_feb_29)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ajuste_nat <span class="ot">&lt;-</span> <span class="fu">bsts</span>(y, modelo_natalidad, <span class="at">niter =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Fri Apr 21 06:46:42 2023 =-=-=-=-=
=-=-=-=-= Iteration 100 Fri Apr 21 06:48:05 2023 =-=-=-=-=
=-=-=-=-= Iteration 200 Fri Apr 21 06:49:28 2023 =-=-=-=-=
=-=-=-=-= Iteration 300 Fri Apr 21 06:50:51 2023 =-=-=-=-=
=-=-=-=-= Iteration 400 Fri Apr 21 06:52:15 2023 =-=-=-=-=
=-=-=-=-= Iteration 500 Fri Apr 21 06:53:38 2023 =-=-=-=-=
=-=-=-=-= Iteration 600 Fri Apr 21 06:55:01 2023 =-=-=-=-=
=-=-=-=-= Iteration 700 Fri Apr 21 06:56:24 2023 =-=-=-=-=
=-=-=-=-= Iteration 800 Fri Apr 21 06:57:48 2023 =-=-=-=-=
=-=-=-=-= Iteration 900 Fri Apr 21 06:59:11 2023 =-=-=-=-=</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mean_contrib <span class="ot">&lt;-</span> ajuste_nat<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), mean)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>mean_contrib_tbl <span class="ot">&lt;-</span> mean_contrib <span class="sc">|&gt;</span> <span class="fu">t</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fecha =</span> natalidad_tbl<span class="sc">$</span>fecha) <span class="sc">|&gt;</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trend_c =</span> trend <span class="sc">-</span> <span class="fu">mean</span>(trend)) <span class="sc">|&gt;</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>trend) <span class="sc">|&gt;</span> </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(seasonal.<span class="fl">7.1</span><span class="sc">:</span>dynamic, trend_c),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"componente"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mean_contrib_tbl, <span class="fu">aes</span>(<span class="at">x =</span> fecha, <span class="at">y =</span> valor)) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> componente) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos ver con más detalle cómo es el efecto de los días de asueto y sus “hombros”, tomando por ejemplo 2008-2009:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mean_contrib_tbl <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(<span class="fu">year</span>(fecha) <span class="sc">==</span> <span class="dv">2009</span> <span class="sc">&amp;</span> <span class="fu">month</span>(fecha) <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">|</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">year</span>(fecha) <span class="sc">==</span> <span class="dv">2008</span> <span class="sc">&amp;</span> <span class="fu">month</span>(fecha) <span class="sc">&gt;=</span> <span class="dv">12</span>), </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> fecha, <span class="at">y =</span> valor)) <span class="sc">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> componente) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Obs</strong>: este modelo todavía requiere considerar qué otros efectos adicionales están actuando. La distribución de errores a un paso tiene colas largas, y todavía hay cierta información que podríamos usar para mejorar las predicción si consideramos la ACF de las innovaciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>error <span class="ot">&lt;-</span> ajuste_nat<span class="sc">$</span>one.step.prediction.errors <span class="sc">|&gt;</span> <span class="fu">apply</span>(<span class="dv">2</span>, mean)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>error_sin_2008 <span class="ot">&lt;-</span> error[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">365</span>)]</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(error_sin_2008)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="576"></p>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>natalidad_tbl<span class="sc">$</span>error <span class="ot">&lt;-</span> error</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ACF</span>(natalidad_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">year</span>(fecha) <span class="sc">&gt;</span> <span class="dv">2008</span>), </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    error) <span class="sc">|&gt;</span> <span class="fu">autoplot</span>() <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid" width="576"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>natalidad_tbl <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(fecha) <span class="sc">&gt;</span> <span class="dv">2008</span>) <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(error))) <span class="sc">|&gt;</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dia_sem =</span> <span class="fu">weekdays</span>(fecha)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by ``, `fecha` first.
Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by ``, `fecha` first.
Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by ``, `fecha` first.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 2,922 x 5 [1D]
   fecha      nacimientos feb_29  error dia_sem 
   &lt;date&gt;           &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;   
 1 2013-01-01        8.45      0 -0.199 Tuesday 
 2 2009-11-02        8.64      0 -0.186 Monday  
 3 2012-09-16        8.66      0  0.172 Sunday  
 4 2016-11-21        8.49      0 -0.172 Monday  
 5 2012-12-25        8.47      0 -0.167 Tuesday 
 6 2016-12-25        8.15      0  0.162 Sunday  
 7 2014-05-01        8.57      0 -0.161 Thursday
 8 2015-11-16        8.56      0 -0.159 Monday  
 9 2015-05-01        8.55      0 -0.158 Friday  
10 2012-11-19        8.66      0 -0.150 Monday  
# … with 2,912 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="nowcasting-y-uso-de-covariables" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="nowcasting-y-uso-de-covariables"><span class="header-section-number">9.3</span> Nowcasting y uso de covariables</h2>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Nowcasting
</div>
</div>
<div class="callout-body-container callout-body">
<p>En nowcasting buscamos predecir los valores contemporáneos de una serie de tiempo que, por retrasos en reporte, no tenemos disponibles. Usualmente utilizamos variables asociadas contemporáneas que sí están disponibles, y se trata de pronósticos a corto plazo</p>
</div>
</div>
<p>Un ejemplo es el indicador oportuno de actividad económica que se publica mensualmente. Este indicador busca estimar el IGAE (indicador global de actividad económica), y utiliza variables económicas, financieras y otras, disponibles al momento (mientras que el IGAE se publica con unos dos meses de retraso). Ver aquí: https://www.inegi.org.mx/investigacion/ioae/.</p>
<p>Una estrategia puede ser incluír variables relevantes cómo en regresión dinámica. Sin embargo, si estamos buscando entre una cantidad relativamente grande de predictores, es posible obtener mejores resultados haciendo selección de variables. En el caso de <em>bsts</em> se utiliza una inicial de <em>spike-slab</em>, que es una mezcla de una masa de probabilidad mayor a 0 para un valor del coeficiente igual a 0 (es decir, la variable está excluída del modelo), y una distribución normal centrada en 0 (el coeficiente puede tomar un valor positivo o negativo).</p>
<p>En este ejemplo consideraremos (<span class="citation" data-cites="scottvarian2015">Scott y Varian (<a href="99-referencias.html#ref-scottvarian2015" role="doc-biblioref">2015</a>)</span>) el pronóstico oportuno de los números semanales reclamaciones pagos de seguro de desempleo en Estados Unidos, que se reportan varios días después de que cierra cada semana. En el artículo citado, utilizan medidas relativa de popularidad de búsquedas relacionadas con desempleo en Google, que se pueden tener de manera completa en cuanto la semana cierra. Ver también <a href="https://www.nber.org/system/files/working_papers/w19567/w19567.pdf">aquí</a> o <a href="https://www.unofficialgoogledatascience.com/2017/07/fitting-bayesian-structural-time-series.html">aquí</a>.</p>
<p>Este código está adaptado de <a href="https://www.unofficialgoogledatascience.com/2017/07/fitting-bayesian-structural-time-series.html">aqui</a>, ver también <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/41335.pdf">este reporte</a>.</p>
<p>Primero construiremos un modelo con tendencia lineal y estacionalidad. En este caso, como consideramos una serie relativamente corta (no más de 10 años), y la estacionalidad es dinámica, podemos usar un periodo de 52 semanas, aún cuando sabemos que algunos años tienen 53 semanas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(iclaims)     </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>original.claims <span class="ot">&lt;-</span> initial.claims</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>initial.claims <span class="ot">&lt;-</span> original.claims[<span class="dv">1</span><span class="sc">:</span><span class="dv">436</span>, ]</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>new.data <span class="ot">&lt;-</span> original.claims[<span class="dv">437</span><span class="sc">:</span><span class="dv">456</span>, ]</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), initial.claims<span class="sc">$</span>iclaimsNSA)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">AddSeasonal</span>(ss, initial.claims<span class="sc">$</span>iclaimsNSA, <span class="at">nseasons =</span> <span class="dv">52</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(initial.claims<span class="sc">$</span>iclaimsNSA,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">state.specification =</span> ss,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">niter =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Fri Apr 21 07:00:39 2023 =-=-=-=-=
=-=-=-=-= Iteration 100 Fri Apr 21 07:00:43 2023 =-=-=-=-=
=-=-=-=-= Iteration 200 Fri Apr 21 07:00:48 2023 =-=-=-=-=
=-=-=-=-= Iteration 300 Fri Apr 21 07:00:52 2023 =-=-=-=-=
=-=-=-=-= Iteration 400 Fri Apr 21 07:00:56 2023 =-=-=-=-=
=-=-=-=-= Iteration 500 Fri Apr 21 07:01:01 2023 =-=-=-=-=
=-=-=-=-= Iteration 600 Fri Apr 21 07:01:05 2023 =-=-=-=-=
=-=-=-=-= Iteration 700 Fri Apr 21 07:01:09 2023 =-=-=-=-=
=-=-=-=-= Iteration 800 Fri Apr 21 07:01:13 2023 =-=-=-=-=
=-=-=-=-= Iteration 900 Fri Apr 21 07:01:18 2023 =-=-=-=-=</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1, <span class="st">"components"</span>)  </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y podemos construir predicciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>pred1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model1, <span class="at">horizon =</span> <span class="dv">12</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1, <span class="at">plot.original =</span> <span class="dv">156</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Entre las variables de términos de búsqueda están</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(initial.claims)[<span class="sc">-</span><span class="dv">1</span>]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "michigan.unemployment"      "idaho.unemployment"        
 [3] "pennsylvania.unemployment"  "unemployment.filing"       
 [5] "new.jersey.unemployment"    "department.of.unemployment"
 [7] "illinois.unemployment"      "rhode.island.unemployment" 
 [9] "unemployment.office"        "filing.unemployment"       </code></pre>
</div>
</div>
<p>Seleccionamos una inicial para el tamaño esperado del modelo (y después seleccionamos según desempeño predictivo):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(iclaimsNSA <span class="sc">~</span> .,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">state.specification =</span> ss,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">niter =</span> <span class="dv">1000</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> initial.claims, </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">expected.model.size =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Fri Apr 21 07:01:23 2023 =-=-=-=-=
=-=-=-=-= Iteration 100 Fri Apr 21 07:01:28 2023 =-=-=-=-=
=-=-=-=-= Iteration 200 Fri Apr 21 07:01:32 2023 =-=-=-=-=
=-=-=-=-= Iteration 300 Fri Apr 21 07:01:36 2023 =-=-=-=-=
=-=-=-=-= Iteration 400 Fri Apr 21 07:01:41 2023 =-=-=-=-=
=-=-=-=-= Iteration 500 Fri Apr 21 07:01:45 2023 =-=-=-=-=
=-=-=-=-= Iteration 600 Fri Apr 21 07:01:49 2023 =-=-=-=-=
=-=-=-=-= Iteration 700 Fri Apr 21 07:01:54 2023 =-=-=-=-=
=-=-=-=-= Iteration 800 Fri Apr 21 07:01:58 2023 =-=-=-=-=
=-=-=-=-= Iteration 900 Fri Apr 21 07:02:02 2023 =-=-=-=-=</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(iclaimsNSA <span class="sc">~</span> .,</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">state.specification =</span> ss,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">niter =</span> <span class="dv">1000</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> initial.claims,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">expected.model.size =</span> <span class="dv">6</span>)  <span class="co"># Passed to SpikeSlabPrior.</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Fri Apr 21 07:02:07 2023 =-=-=-=-=
=-=-=-=-= Iteration 100 Fri Apr 21 07:02:11 2023 =-=-=-=-=
=-=-=-=-= Iteration 200 Fri Apr 21 07:02:15 2023 =-=-=-=-=
=-=-=-=-= Iteration 300 Fri Apr 21 07:02:20 2023 =-=-=-=-=
=-=-=-=-= Iteration 400 Fri Apr 21 07:02:24 2023 =-=-=-=-=
=-=-=-=-= Iteration 500 Fri Apr 21 07:02:28 2023 =-=-=-=-=
=-=-=-=-= Iteration 600 Fri Apr 21 07:02:33 2023 =-=-=-=-=
=-=-=-=-= Iteration 700 Fri Apr 21 07:02:37 2023 =-=-=-=-=
=-=-=-=-= Iteration 800 Fri Apr 21 07:02:41 2023 =-=-=-=-=
=-=-=-=-= Iteration 900 Fri Apr 21 07:02:46 2023 =-=-=-=-=</code></pre>
</div>
</div>
<p>Comparamos los modelos con el error de pronóstico a un paso, y el modelo 2 es el de mejor desempeño:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CompareBstsModels</span>(<span class="fu">list</span>(<span class="st">"Modelo s.vars"</span> <span class="ot">=</span> model1,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Modelo esp2"</span> <span class="ot">=</span> model2,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Modelo esp6"</span> <span class="ot">=</span> model3),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>pred2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model2, <span class="at">horizon =</span> <span class="dv">12</span>, <span class="at">newdata =</span> new.data[<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, ])</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred2, <span class="at">plot.original =</span> <span class="dv">156</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos ver qué variables fueron seleccionadas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model2, <span class="st">"coefficients"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-aplicaciones-espacio-estados_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="agregación-de-encuestas" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="agregación-de-encuestas"><span class="header-section-number">9.4</span> Agregación de encuestas</h2>
</section>
<section id="impacto-causal" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="impacto-causal"><span class="header-section-number">9.5</span> Impacto causal</h2>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-durbinkoopman" class="csl-entry" role="doc-biblioentry">
Durbin, J., y S. J. Koopman. 2001. <em>Time Series Analysis by State Space Methods</em>. Oxford Statistical Science Series. Clarendon Press. <a href="https://books.google.com.mx/books?id=XRCu5iSz\_HwC">https://books.google.com.mx/books?id=XRCu5iSz\_HwC</a>.
</div>
<div id="ref-hyndman2014" class="csl-entry" role="doc-biblioentry">
Hyndman, R. J., y G. Athanasopoulos. 2014. <em>Forecasting: principles and practice</em>. OTexts. <a href="https://books.google.com.mx/books?id=gDuRBAAAQBAJ">https://books.google.com.mx/books?id=gDuRBAAAQBAJ</a>.
</div>
<div id="ref-scottvarian2015" class="csl-entry" role="doc-biblioentry">
Scott, Steven L., y Hal R. Varian. 2015. <em><span>Bayesian Variable Selection for Nowcasting Economic Time Series</span></em>. University of Chicago Press. <a href="https://doi.org/10.7208/chicago/9780226206981.003.0004">https://doi.org/10.7208/chicago/9780226206981.003.0004</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./08-modelos-1.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modelos de espacio de estados</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./99-referencias.html" class="pagination-link">
        <span class="nav-page-text">Referencias</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>