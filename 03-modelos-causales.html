<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Métodos analíticos - 3&nbsp; Modelos causales e inferencia</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./99-referencias.html" rel="next">
<link href="./02-modelos-graficos.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script>
<script src="site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="site_libs/viz-1.8.2/viz.js"></script>
<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="site_libs/grViz-binding-1.0.9/grViz.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelos causales e inferencia</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Métodos analíticos</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Temario y referencias</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción (Parte 1)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-modelos-graficos.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Modelos gráficos probabilísticos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-modelos-causales.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelos causales e inferencia</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-referencias.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./apendice-1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Apéndice 1</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#intervenciones" id="toc-intervenciones" class="nav-link active" data-scroll-target="#intervenciones"><span class="toc-section-number">3.1</span>  Intervenciones</a>
  <ul class="collapse">
  <li><a href="#ejemplo-pearl" id="toc-ejemplo-pearl" class="nav-link" data-scroll-target="#ejemplo-pearl">Ejemplo (Pearl)</a></li>
  </ul></li>
  <li><a href="#ejemplo-una-intervención-simple" id="toc-ejemplo-una-intervención-simple" class="nav-link" data-scroll-target="#ejemplo-una-intervención-simple"><span class="toc-section-number">3.2</span>  Ejemplo: una intervención simple</a></li>
  <li><a href="#cálculo-do-de-pearl" id="toc-cálculo-do-de-pearl" class="nav-link" data-scroll-target="#cálculo-do-de-pearl"><span class="toc-section-number">3.3</span>  Cálculo-do de Pearl</a>
  <ul class="collapse">
  <li><a href="#ejemplo" id="toc-ejemplo" class="nav-link" data-scroll-target="#ejemplo">Ejemplo</a></li>
  </ul></li>
  <li><a href="#fórmula-de-ajuste" id="toc-fórmula-de-ajuste" class="nav-link" data-scroll-target="#fórmula-de-ajuste"><span class="toc-section-number">3.4</span>  Fórmula de ajuste</a></li>
  <li><a href="#experimentos" id="toc-experimentos" class="nav-link" data-scroll-target="#experimentos"><span class="toc-section-number">3.5</span>  Experimentos</a></li>
  <li><a href="#simulación-para-estimar-efectos-causales" id="toc-simulación-para-estimar-efectos-causales" class="nav-link" data-scroll-target="#simulación-para-estimar-efectos-causales"><span class="toc-section-number">3.6</span>  Simulación para estimar efectos causales</a></li>
  <li><a href="#ejemplo-estaturas-versión-1" id="toc-ejemplo-estaturas-versión-1" class="nav-link" data-scroll-target="#ejemplo-estaturas-versión-1"><span class="toc-section-number">3.7</span>  Ejemplo: estaturas (versión 1)</a></li>
  <li><a href="#bloqueando-puertas-traseras" id="toc-bloqueando-puertas-traseras" class="nav-link" data-scroll-target="#bloqueando-puertas-traseras"><span class="toc-section-number">3.8</span>  Bloqueando puertas traseras</a>
  <ul class="collapse">
  <li><a href="#ejemplo-pearl-1" id="toc-ejemplo-pearl-1" class="nav-link" data-scroll-target="#ejemplo-pearl-1">Ejemplo (Pearl)</a></li>
  <li><a href="#ejemplo-1" id="toc-ejemplo-1" class="nav-link" data-scroll-target="#ejemplo-1">Ejemplo</a></li>
  </ul></li>
  <li><a href="#reglas-del-cálculo-do-opcional" id="toc-reglas-del-cálculo-do-opcional" class="nav-link" data-scroll-target="#reglas-del-cálculo-do-opcional"><span class="toc-section-number">3.9</span>  Reglas del cálculo-do (opcional)</a></li>
  <li><a href="#el-criterio-de-puerta-delantera" id="toc-el-criterio-de-puerta-delantera" class="nav-link" data-scroll-target="#el-criterio-de-puerta-delantera"><span class="toc-section-number">3.10</span>  El criterio de puerta delantera</a>
  <ul class="collapse">
  <li><a href="#ejemplo-proceso-generador" id="toc-ejemplo-proceso-generador" class="nav-link" data-scroll-target="#ejemplo-proceso-generador">Ejemplo: proceso generador</a></li>
  <li><a href="#ejemplo-estimación-con-puerta-delantera" id="toc-ejemplo-estimación-con-puerta-delantera" class="nav-link" data-scroll-target="#ejemplo-estimación-con-puerta-delantera">Ejemplo: estimación con puerta delantera</a></li>
  </ul></li>
  <li><a href="#mediación-y-datos-de-berkeley" id="toc-mediación-y-datos-de-berkeley" class="nav-link" data-scroll-target="#mediación-y-datos-de-berkeley"><span class="toc-section-number">3.11</span>  Mediación y datos de Berkeley</a>
  <ul class="collapse">
  <li><a href="#ejemplo-admisiones-de-berkeley" id="toc-ejemplo-admisiones-de-berkeley" class="nav-link" data-scroll-target="#ejemplo-admisiones-de-berkeley"><span class="toc-section-number">3.11.1</span>  Ejemplo: Admisiones de Berkeley</a></li>
  <li><a href="#ejemplo-burks-pearl" id="toc-ejemplo-burks-pearl" class="nav-link" data-scroll-target="#ejemplo-burks-pearl"><span class="toc-section-number">3.11.2</span>  Ejemplo (Burks, Pearl)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelos causales e inferencia</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>En esta parte consideramos nuestros modelos gráficos no simplemente como maneras de factorizar un modelo probabilístico, sino también como una manera de establecer nuestros supuestos causales acerca del problema de interés. Estos son supuestos que son necesarios para hacer inferencia causal.</p>
<p>Comenzaremos entonces con una pregunta fundamental de inferencia causal: ¿qué sucede si modificamos una variable <span class="math inline">\(X=x\)</span> a una variable respuesta <span class="math inline">\(Y\)</span>? ¿Podemos estimar este efecto a partir de datos observados? La respuesta dependerá de nuestros supuestos causales, y veremos varios ejemplos de cuándo es posible y cómo <strong>identificar</strong> y calcular estas estimaciones causales.</p>
<section id="intervenciones" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="intervenciones"><span class="header-section-number">3.1</span> Intervenciones</h2>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_light</span>())</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> \(x) <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Desde el punto de vista de Pearl, nuestro objeto principal de interés es la distribución condicional de la respuesta <em>dada una manipulación</em>, que define como <span class="math display">\[p(y | do(x))\]</span> Esto significa: ¿cómo se distribuye la <span class="math inline">\(Y\)</span> dado que intervenimos en la población completa (aunque podemos también considerar subpoblaciones más adelante) para poner en <span class="math inline">\(X=x\)</span>?. En primer lugar, notemos que esto no es lo mismo que la distribución</p>
<p><span class="math display">\[p(y|x)\]</span> que podemos estimar directamente de los datos.</p>
<section id="ejemplo-pearl" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-pearl">Ejemplo (Pearl)</h3>
<p>Supongamos que tenemos el siguiente modelo del diagrama causal:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="st">   U_t -&gt; T</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; A</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; Z</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="st">   U_a -&gt; A</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="st">   U_z -&gt; Z</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-c4f874e705614d96d820" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-c4f874e705614d96d820">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n\n  edge [minlen = 3]\n   U_t -> T\n   T -> A\n   T -> Z\n   U_a -> A\n   U_z -> Z\n   \n   \n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>donde <span class="math inline">\(T\)</span> es la temperatura, <span class="math inline">\(A\)</span> son las unidades de agua embotellada vendida y <span class="math inline">\(Z\)</span> es la actividad de los mosquitos (medido con muestreo, por ejemplo). Mostramos también otras variables causales que pueden afectar a las variables de interés (muchas veces omitimos estas variables que solo afectan a una variable de interés), pero que no tienen efecto sobre otras variables del diagrama.</p>
<p>No interesa contestar la pregunta: ¿qué tanto influyen las ventas de agua embotellada en la actividad de los mosquitos? Del diagrama, sabemos que no hay ningún camino causal de <span class="math inline">\(Z\)</span> a <span class="math inline">\(T\)</span>, por lo que nuestra respuesta debería ser igual a 0.</p>
<p>Sin embargo, sabemos que estas dos variables están asociadas (por el análisis de DAGs), de manera que describir cómo cambia <span class="math inline">\(p(z|a)\)</span> cuando condicionamos a distintos valores de <span class="math inline">\(a\)</span> no responde nuestra pregunta. La distribución <span class="math inline">\(p(z|do(a))\)</span> nos dice cómo se distribuye <span class="math inline">\(Z\)</span> cuando manipulamos <span class="math inline">\(a\)</span> artificialmente. Por ejemplo, si cerramos todas las tiendas un día haciendo <span class="math inline">\(do(a=0)\)</span>, veríamos que esta variable no tiene efecto sobre la actividad de mosquitos, por ejemplo comparado con <span class="math inline">\(do(a = 10000)\)</span>.</p>
<p>Ilustramos la diferencia entre <span class="math inline">\(p(y|x)\)</span> y <span class="math inline">\(p(y|do(x))\)</span> simulando del ejemplo anterior. Supondremos que sólo consideramos un día del año a lo largo de varios años, para no modelar el comportamiento cíclo de la temperatura:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>simular_t <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">dia =</span> <span class="dv">150</span>){</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simular un año, alrededor del día 160 (en junio)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  t_maxima <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">28</span>, <span class="dv">2</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  mosquitos <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="dv">250</span> <span class="sc">+</span> <span class="dv">10</span> <span class="sc">*</span> (t_maxima <span class="sc">-</span> <span class="dv">28</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  a_unidades <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">20000</span> <span class="sc">+</span> <span class="dv">2000</span> <span class="sc">*</span> (t_maxima <span class="sc">-</span>  <span class="dv">28</span>), <span class="dv">2000</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(t_maxima, a_unidades, mosquitos)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">128</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>simular_dias <span class="ot">&lt;-</span> <span class="fu">simular_t</span>(<span class="dv">50</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si simulamos, vemos que <span class="math inline">\(mosquitos\)</span> y <span class="math inline">\(unidades\)</span> son dependientes, pues tenemos un camino abierto dado por la bifurcación en temperatura:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simular_dias, <span class="fu">aes</span>(<span class="at">x =</span> a_unidades, <span class="at">y =</span> mosquitos)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Ventas de agua embotellada"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Sabemos que esta asociación no es causal, pues no hay caminos causales entre estas variables dos variables, pero que hay una dependencia debido a la bifurcación en <span class="math inline">\(T\)</span>. La gráfica muestra que la media condicional <span class="math inline">\(E[M|A=a]\)</span> depende fuertemente de <span class="math inline">\(a\)</span>, lo que quiere decir que <span class="math inline">\(p(m|a)\)</span> depende de <span class="math inline">\(a\)</span> fuertemente.</p>
</section>
</section>
<section id="ejemplo-una-intervención-simple" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="ejemplo-una-intervención-simple"><span class="header-section-number">3.2</span> Ejemplo: una intervención simple</h2>
<p>En este caso, nos interesaría saber qué sucede si alteramos artificalmente el número de botellas de agua vendidas (puedes imaginar distintas maneras de hacer esto).</p>
<p>Cuando hacemos esto, quitamos las aristas que van hacia <span class="math inline">\(A\)</span>, pues <span class="math inline">\(A\)</span> ya no está determinado por el proceso generador de datos. Tenemos entonces la nueva gráfica:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">   A</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="st">   U_t -&gt; T</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; Z</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">   U_m -&gt; Z</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="st">{ rank = same; A; Z }</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-e693b0f1d893068fbf1d" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-e693b0f1d893068fbf1d">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n   A\n  edge [minlen = 3]\n   U_t -> T\n   T -> Z\n   U_m -> Z\n{ rank = same; A; Z }\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>En esta nueva gráfica, <span class="math inline">\(A\)</span> y <span class="math inline">\(Z\)</span> son independientes, que es la respuesta correcta. Como cambiamos la gráfica, su proceso generador es diferente al original de los datos observados. Sin embargo, en este ejemplo puedes ver por qué es claro que el cambio que hicimos (manipular <span class="math inline">\(A\)</span> en lugar de que esté determinado por su proceso generador original) no cambia el modelo de <span class="math inline">\(Z\)</span>, de manera que podemos simular de nuestro nuevo proceso generador donde manipulamos <span class="math inline">\(A\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>simular_cirugia <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">a_unidades =</span> a_unidades){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simular un año, alrededor del día 160 (en junio)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  t_maxima <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">28</span>, <span class="dv">2</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### cirugía #########</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ahora a_unidades es fijado por nosotros:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a_unidades &lt;- rnorm(n, 20000 + 2000 * (t_maxima -  28), 2000)</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  a_unidades <span class="ot">&lt;-</span> a_unidades</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">######################</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  mosquitos <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="dv">250</span> <span class="sc">+</span> <span class="dv">10</span> <span class="sc">*</span> (t_maxima <span class="sc">-</span> <span class="dv">28</span>))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(t_maxima, a_unidades, mosquitos)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y ahora simulamos y graficamos <span class="math inline">\(p(z|do(a))\)</span> para distintos valores de <span class="math inline">\(u\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">128</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>simular_dias_2 <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">seq</span>(<span class="dv">10000</span>, <span class="dv">30000</span>, <span class="dv">1000</span>),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  \(u) <span class="fu">simular_cirugia</span>(<span class="dv">50</span>, <span class="at">a_unidades =</span> u))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simular_dias_2, <span class="fu">aes</span>(<span class="at">x =</span> a_unidades, <span class="at">y =</span> mosquitos)) <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_smooth</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>y vemos, como esperaríamos, que no hay relación entre unidades de agua embotellada y tasa de crimen.</p>
</section>
<section id="cálculo-do-de-pearl" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="cálculo-do-de-pearl"><span class="header-section-number">3.3</span> Cálculo-do de Pearl</h2>
<p>El cálculo do nos da reglas para operar con probabilidades que incluyen nuestro operador <em>do</em> de intervención. En este ejemplo particular, veremos cómo es el argumento:</p>
<p>Nótese que al intervenir <span class="math inline">\(A\)</span> hemos modificado el proceso generador. Si la conjunta original tiene distribución <span class="math inline">\(p\)</span>, escribimos <span class="math inline">\(p_m\)</span> para la conjunta de la gráfica modificada, de manera que <span class="math inline">\(p(z|do(a)) = p_m(z|a)\)</span>.</p>
<p>Aunque intuitivamente vimos cómo simular de esta distribución arriba, especificamos abajo qué reglas son las que nos permiten hacer esto: ¿cómo calculamos <span class="math inline">\(p_m\)</span>?</p>
<p>En primer lugar, consideremos <span class="math inline">\(p_m(t)\)</span>. Esta marginal es invariante a nuestra cirugía, pues la arista <span class="math inline">\(T\to A\)</span> que eliminamos <span class="math inline">\(T\)</span> no afecta el proceso que determina <span class="math inline">\(T\)</span>. De modo que la marginal del proceso modificado es igual a la marginal observada:</p>
<p><span class="math display">\[p_m(t) = p(t)\]</span> En segundo lugar, tenemos que</p>
<p><span class="math display">\[p_m(z|t,a) = p(z|t,a),\]</span> Pues el proceso por el cual <span class="math inline">\(Z\)</span> responde a <span class="math inline">\(T\)</span> y <span class="math inline">\(A\)</span> es el mismo, no importa si <span class="math inline">\(A\)</span> fue modificada artificalmente o no.</p>
<p>Juntamos estos argumentos. Primero, por definición,</p>
<p><span class="math display">\[p(z|do(a)) = p_m(z|a)\]</span></p>
<p>Por la regla de probabilidad total, podemos condicionar todo a <span class="math inline">\(T\)</span> y marginalizar. La segunda igualdad la obtenemos por la independencia entre <span class="math inline">\(T\)</span> y <span class="math inline">\(Z\)</span> en nuestra gráfica modificada (están <span class="math inline">\(d\)</span> separadas):</p>
<p><span class="math display">\[p_m(z|a) = \int p_m(z|a,t)p_m(t|a)dt = \int p_m(z|a,t)p_m(t)dt\]</span> En segunda igualdad, nótese que cambiamos <span class="math inline">\(p_m(t|a) = p_m(t)\)</span>, lo cual podemos verificar pues en la gráfica modificada <span class="math inline">\(A\)</span> y <span class="math inline">\(T\)</span> están <span class="math inline">\(d\)</span>-separados.</p>
<p>Finalmente, las últimas dos distribuciones podemos extraerlas de los datos, como explicamos arriba <span class="math inline">\(p_m(z|t,a) = p(z|t,a)\)</span> y <span class="math inline">\(p_m(t) = p(t),\)</span> y terminamos con la fórmula</p>
<p><span class="math display">\[p(z|do(a))=p_m(z|a) = \int p(z|a,t)p(t)dt \]</span></p>
<p>Las dos distribuciones de la derecha pueden ser estimadas pues están en el contexto de <span class="math inline">\(p\)</span>, el proceso generador de datos. Así que podemos estimarlas de los datos observados.</p>
<ul>
<li>Este argumento justifica el proceso que hicimos arriba: simulamos primero <span class="math inline">\(T\)</span> con su proceso generador, y después simulamos <span class="math inline">\(Z\)</span> condicional a <span class="math inline">\(A\)</span> y <span class="math inline">\(T\)</span> <em>según el proceso generador original</em>, el cual no depende de <span class="math inline">\(A\)</span> en este ejemplo.</li>
</ul>
<p>En el caso de arriba, simulamos de la distribución para entender cómo se distribuía <span class="math inline">\(Z\)</span> dependiendo de modificaciones a <span class="math inline">\(A\)</span>. Muchas veces nos interesa calcular solamente la esperanza condicional, es decir, cuál es el valor esperado de la variable de interés dado el nivel intervenido, es decir:</p>
<p><span class="math inline">\(E(Z|do(a)) = E_m(Z|A =a),\)</span></p>
<p>que mostramos arriba con la línea ajustada. También quisiéramos calcular <strong>contrastes</strong> particulares, como qué pasaría si las ventas de agua las aumentamos en 10 mil unidades:</p>
<p><span class="math display">\[E(Z|do(30000)) - E(Z|do(20000)),\]</span> que podemos calcular de manera simple con simulación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>simular_contraste <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">c</span>(<span class="dv">20000</span>, <span class="dv">30000</span>),</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  \(u) <span class="fu">simular_cirugia</span>(<span class="dv">1000</span>, <span class="at">a_unidades =</span> u)) <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(a_unidades) <span class="sc">|&gt;</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_mosquitos =</span> <span class="fu">mean</span>(mosquitos))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>simular_contraste</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  a_unidades media_mosquitos
       &lt;dbl&gt;           &lt;dbl&gt;
1      20000            250.
2      30000            249.</code></pre>
</div>
</div>
<p>Y vemos que no hay diferencia entre las dos medias.</p>
<section id="ejemplo" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo">Ejemplo</h3>
<p>Ahora hagamos otro ejemplo donde hay una relación causal que queremos estimar. Imaginemos una ciudad en donde temperaturas altas producen desabasto de agua en algunos hogares, debido a un aumento del riego. Nos interesa estimar el efecto del desabasto en las compras de agua embotellada. Nuestro diagrama ahora es:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="st">   U_t -&gt; T</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; A</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; D</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="st">   D -&gt; A</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="st">   U_a -&gt; A</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="st">   U_d -&gt; D</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="st">{ rank = same; A; D }</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-3fed6461373671766c5d" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-3fed6461373671766c5d">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n\n  edge [minlen = 3]\n   U_t -> T\n   T -> A\n   T -> D\n   D -> A\n   U_a -> A\n   U_d -> D\n\n{ rank = same; A; D }\n\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>simular_t <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">dia =</span> <span class="dv">150</span>){</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simular un año, alrededor del día 160 (en junio)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  t_maxima <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">28</span>, <span class="dv">2</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  desabasto_agua <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(t_maxima <span class="sc">-</span> <span class="dv">28</span>) <span class="sc">+</span> u))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  unidades <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">20000</span> <span class="sc">+</span> <span class="dv">2000</span> <span class="sc">*</span> (t_maxima <span class="sc">-</span>  <span class="dv">28</span>) <span class="sc">+</span> <span class="dv">8000</span><span class="sc">*</span>desabasto_agua, <span class="dv">2000</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(t_maxima, unidades, desabasto_agua)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">128</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>simular_dias <span class="ot">&lt;-</span> <span class="fu">simular_t</span>(<span class="dv">150</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simular_dias, <span class="fu">aes</span>(<span class="at">x =</span> desabasto_agua, <span class="at">y =</span> unidades)) <span class="sc">+</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_smooth</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>La correlación parece muy fuerte, sin embargo, sabemos que hay un camino no causal de asociación entre estas dos variables.</p>
<p>Igual que en ejemplo anterior, vamos a intervenir teóricamente en el desabasto de agua. Después de la cirugía, nuestro diagrama modificado es:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="st">   U_t -&gt; T</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; A</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="st">   D -&gt; A</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="st">   U_a -&gt; A</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="st">{ rank = same; A; D }</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-fcea90e6193ca2f7c331" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-fcea90e6193ca2f7c331">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n\n  edge [minlen = 3]\n   U_t -> T\n   T -> A\n   D -> A\n   U_a -> A\n{ rank = same; A; D }\n\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Ahora queremos calcular <span class="math inline">\(p(a|do(d)) = p_m(a|d)\)</span> en función de los datos. Siguiendo el mismo argumento que en el ejemplo anterior, sabemos que tenemos que estratificar o condicionar a <span class="math inline">\(T\)</span> para poder usar nuestro proceso generador de observaciones, y obtenemos:</p>
<p><span class="math display">\[p(a|do(d))=p_m(a|d) = \int p(a|d,t)p(t)dt \]</span> Aunque a veces es posible calcular analíticamente el lado derecho analíticamente, podemos simular como hicimos en los ejemplos anteriores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>simular_cirugia <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">da =</span> <span class="dv">0</span>){</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simular un año, alrededor del día 160 (en junio)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  t_maxima <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">28</span>, <span class="dv">2</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">### cirugía ####</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#u &lt;- rnorm(n, 0, 1) </span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  desabasto_agua <span class="ot">&lt;-</span> da</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">######</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  unidades <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">20000</span> <span class="sc">+</span> <span class="dv">2000</span> <span class="sc">*</span> (t_maxima <span class="sc">-</span>  <span class="dv">28</span>) <span class="sc">+</span> <span class="dv">8000</span><span class="sc">*</span>desabasto_agua, <span class="dv">2000</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(t_maxima, unidades, desabasto_agua)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">128</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>simular_dias_c <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>), \(da) <span class="fu">simular_cirugia</span>(<span class="dv">1000</span>, <span class="at">da =</span> da))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simular_dias_c, <span class="fu">aes</span>(<span class="at">x =</span> desabasto_agua, <span class="at">y =</span> unidades)) <span class="sc">+</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_smooth</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Podemos también resumir promediando:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>simular_dias_c <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(desabasto_agua) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unidades_media =</span> <span class="fu">mean</span>(unidades)) <span class="sc">|&gt;</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> desabasto_agua, <span class="at">y =</span> unidades_media)) <span class="sc">+</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_smooth</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y este es el efecto causal del desabasto de agua. No tenemos medidas de incertidumbre pues conocemos todos los parámetros de los modelos. La media condicional parece ser lineal, así que podríamos resumir con un modelo lineal:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 1 (con datos de intervención)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(unidades <span class="sc">~</span> desabasto_agua, simular_dias_c)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = unidades ~ desabasto_agua, data = simular_dias_c)

Coefficients:
   (Intercept)  desabasto_agua  
         19831            8272  </code></pre>
</div>
</div>
<p>Aproximadamente, cada incremento en puntos porcentuales de 10% en desabasto incrementa las ventas en unas 800 unidades. Compara con el análisis donde no estratificamos o controlamos por la temperatura:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 2</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(unidades <span class="sc">~</span> desabasto_agua, simular_dias)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = unidades ~ desabasto_agua, data = simular_dias)

Coefficients:
   (Intercept)  desabasto_agua  
         14102           19491  </code></pre>
</div>
</div>
<p>Otra forma de estratificar es ajustando un modelo que incluye la variable de temperatura. Podríamos hacer</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo 3</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(unidades <span class="sc">~</span> desabasto_agua <span class="sc">+</span> t_maxima, simular_dias)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = unidades ~ desabasto_agua + t_maxima, data = simular_dias)

Coefficients:
   (Intercept)  desabasto_agua        t_maxima  
        -35030            8648            1948  </code></pre>
</div>
</div>
</section>
</section>
<section id="fórmula-de-ajuste" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="fórmula-de-ajuste"><span class="header-section-number">3.4</span> Fórmula de ajuste</h2>
<p>En resumen, tenemos la primera regla de Pearl de inferencia causal:</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Fórmula de ajuste (Pearl)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sea <span class="math inline">\(G\)</span> donde los padres de <span class="math inline">\(X\)</span> son <span class="math inline">\(Z_1,Z_2\)</span>. El efecto causal total de <span class="math inline">\(X\)</span> en <span class="math inline">\(Y\)</span> se puede calcular como</p>
<p><span class="math display">\[p(y|do(x)) = \int p(y|x, z_1,z_2) p(z_1,z_2)\, dz_1dz_2\]</span> Es decir, condicionamos al valor de <span class="math inline">\(x\)</span> y todos los padres de <span class="math inline">\(X\)</span> para calcular <span class="math inline">\(p(y|x,z_1,z_2)\)</span>, y después marginalizamos sobre los padres.</p>
</div>
</div>
<p>Esta fórmula se extiende a más de dos padres <span class="math inline">\(Z_1,Z_2,Z_3,\ldots, Z_k\)</span>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>A este proceso se llama de diferentes maneras en distintos contextos:</p>
<ul>
<li>Estamos calculando el efecto causal <strong>estratificando</strong> por las variables <span class="math inline">\(z\)</span>.</li>
<li><strong>Controlamos</strong> por las variables <span class="math inline">\(z\)</span> para calcular el efecto causal.</li>
</ul>
</div>
</div>
<p>Podemos pensar en esta fórmula de dos maneras: en primer lugar, si estamos modelando toda nuestra gráfica causal, podemos simular de la conjunta de la gráfica mutilada:</p>
<ol type="1">
<li>Fijando el nivel del tratamiento <span class="math inline">\(T\)</span></li>
<li>Simulando <span class="math inline">\(p(z_1,z_2,\ldots, z_k)\)</span> (marginalizando estas variables),</li>
<li>Usar <span class="math inline">\(t\)</span> y las <span class="math inline">\(z\)</span> simuladas para simular <span class="math inline">\(y\)</span></li>
</ol>
<p>El otro enfoque busca sólo construir modelos para la parte que nos interesa:</p>
<ol type="1">
<li>Construir un modelo separado para <span class="math inline">\(p(z_1, z_2,\ldots, z_k) = p(z)\)</span> (que puede ser difícil si tenemos muchas variables) a partir los datos</li>
<li>Construir un modelo <span class="math inline">\(p(y|t, z)\)</span> para simular la <span class="math inline">\(y\)</span> a partir de los datos.</li>
<li>Ignoramos el resto de nuestra gráfica en este caso.</li>
</ol>
<p>Finalmente, si tenemos un modelo <span class="math inline">\(p(y| t, z)\)</span> podemos también investigar cómo se comporta <span class="math inline">\(E[y|t_2,z] - E[y|t_1,z]\)</span> para distintos combinaciones de valores de <span class="math inline">\(Z\)</span>.</p>
<p><strong>Nota 1</strong>: Con este principio podemos resolver algunos problemas, pero no todos. Veremos que en algunos casos existen padres que no son observados, por ejemplo, no es posible condicionar para usar la fórmula de ajuste y es necesario desarrollar otras estrategias.</p>
<p><strong>Nota 2</strong>: En regresión lineal, cuando incluímos una variable en el modelo (que consideramos una variable control), estamos estratificando por ella: por ejemplo, en el modelo lineal <span class="math inline">\(U\sim N(m_u(d,t), \sigma_u)\)</span>, donde</p>
<p><span class="math display">\[m_u = \beta_0 +\beta_1 d + \beta_2 t\]</span> Estamos calculando un estimador para cada valor de <span class="math inline">\(T=t\)</span>, que es:</p>
<p><span class="math display">\[m_u = (\beta_0 + \beta_2 t) + \beta_1 d = \gamma_0 + \gamma_1 d\]</span> Esta es una de las maneras más simples de obtener el efecto de <span class="math inline">\(d\)</span> estratificando por, o controlando por <span class="math inline">\(t\)</span>, <em>siempre y cuando los modelos lineales sean apropiados</em>.</p>
<p>Nótese que en este último caso, tenemos que el efecto de <span class="math inline">\(d\)</span> no depende de las covariables, de forma que no es necesario hacer el promedio sobre la conjunta, es decir, suponemos que el efecto causal es el mismo independientemente de los valores de las variables de control. Sin embargo, este no siempre es el caso.</p>
</section>
<section id="experimentos" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="experimentos"><span class="header-section-number">3.5</span> Experimentos</h2>
<p>En los experimentos clásicos, intentamos obtener datos de un proceso generador especial:</p>
<ul>
<li>Asignamos un tratamiento <span class="math inline">\(T\)</span> <strong>al azar</strong>: el punto es que la asignación de tratamiento no esté relacionada con ninguna variable de interés en el proceso generador de datos “natural”.</li>
<li>Como no hay aristas que entren a <span class="math inline">\(T\)</span>, no es necesario llevar a cabo ninguna cirugía y ningún ajuste.</li>
<li>Cuando nosotros hacemos cirugía, estamos proponiendo un proceso generador que imita a un experimento, <em>siempre y cuando nuestros supuestos causales sean correctos</em></li>
</ul>
<p>Por ejemplo, si queremos podemos asignar tratamiento de aspirina o no aspirina a una persona, lo hacemos por ejemplo viendo el dígito de unidades en su fecha de nacimiento. Aunque no tiramos ninguna moneda, este dígito no tiene ninguna relación con las maneras en que el tratamiento puede ayudar a reducir el dolor de cabeza.</p>
<p>Entonces podríamos tener un diagrama como el que sigue, donde queremos estimar el efecto causal de <span class="math inline">\(T\)</span> sobre <span class="math inline">\(Y\)</span>:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2, rankdir = LR]</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="st">   Dia -&gt; T</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; Y</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="st">   X -&gt; Z</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="st">   W -&gt; Z</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="st">   Y -&gt; W </span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="st">   Y -&gt; Z</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="st">   A -&gt; Y</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; A</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="st">   X -&gt; W</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="st">   T -&gt; X</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="st">   S -&gt; Y</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="st">#{ rank = same; A; D }</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-0f4ba2ecee17be22fde0" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-0f4ba2ecee17be22fde0">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2, rankdir = LR]\n\n  node [shape=plaintext]\n  \n\n  edge [minlen = 3]\n   Dia -> T\n   T -> Y\n   X -> Z\n   W -> Z\n   Y -> W \n   Y -> Z\n   A -> Y\n   T -> A\n   X -> W\n   T -> X\n   S -> Y\n#{ rank = same; A; D }\n\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>La variable <span class="math inline">\(Dia\)</span> que determina el tratamiento no tiene aristas en común con ningún otro nodo de nuestro modelo causal, así que para tener una estimación del efecto total en este experimento, no es necesario aplicar ningún ajuste, no importa lo complicada que sea esta gráfica, y podemos usar simplemente <span class="math inline">\(p(y|t)\)</span>. No hay necesidad de estratificar por ninguna variable.</p>
<p>Por el contrario, si tenemos dados condicionados (por ejemplo por algún aspecto se la selección de muestra), o estratificamos sin cuidado por alguna de las otras variables, entonces podríamos agregar inducir asociaciones no causales en nuestra estimación.</p>
<p>Eso quiere decir que para este propósito, podríamos simplemente estimar <span class="math inline">\(p(y|t)\)</span> con un modelo simple. No es un modelo “mecanístico”, ni nos sirve para aprender otras cosas, pero sabemos que da una estrategia de identificación para el efecto causal que nos interesa. Nótese también que puede haber variables sobre las que estratificamos que pueden producir más o menos variabilidad, aún cuando no se creen caminos no causales.</p>
<p>Resumiendo:</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Experimentos e inferencia causal
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Los experimentos nos dan la garantía de que no haya aristas que incidan en el tratamiento que están conectadas con otras partes de la gráfica.</li>
<li>El análisis se simplifica pues basta con estimar el modelo “predictivo” <span class="math inline">\(p(y|x)\)</span>: podemos ignorar el conocimiento experto en este sentido.</li>
<li>Sin embargo, en muchos experimentos podemos estratificar o controlar por algunas variables auxiliares para <strong>mejorar la precisión</strong> o subsanar <strong>fallas</strong> en el proceso de asignación del tratamiento (por ejemplo, datos perdidos).</li>
<li>La decisión de controlar o estratificar por una variable sí depende de más aspectos de la estructura causal del problema, y es necesario entonces expandir más nuestro modelo para saber si es buena idea hacerlo.</li>
<li>También, saber más de la estructura causal nos puede ayudar a mejorar el <strong>diseño</strong> de nuestro experimento</li>
</ul>
</div>
</div>
<p>Más adelante veremos más de diseño de experimentos, qué variables utilizar para mejorar su precisión, y su relación con nuestro análisis basado en DAGs causales.</p>
</section>
<section id="simulación-para-estimar-efectos-causales" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="simulación-para-estimar-efectos-causales"><span class="header-section-number">3.6</span> Simulación para estimar efectos causales</h2>
<p>La estrategia más general y conceptualmente simple (aunque técnicamente puede ser difícil por la multitud de modelos necesarios) para usar la idea de la fórmula de ajuste es utilizar simulación:</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Fórmula de ajuste con simulación
</div>
</div>
<div class="callout-body-container callout-body">
<p>Para calcular efectos causales de <span class="math inline">\(X\)</span> en <span class="math inline">\(Y\)</span> , podemos simular según el proceso generador de la gráfica mutilada donde quitamos todas las aristas que llegan a <span class="math inline">\(X\)</span>. En la práctica, esto implica fijar <span class="math inline">\(X\)</span>, ignorar el proceso generador de <span class="math inline">\(X\)</span>, y seguir el proceso generador original de nuestro modelo para el resto de los nodos.</p>
</div>
</div>
<p>Nótese que cuando hacemos las simulaciones siguiendo el proceso generador, marginalizar es simple: si queremos la conjunta de <span class="math inline">\(x_1\)</span> y <span class="math inline">\(x_2\)</span> por ejemplo, simplemente extraemos las variables <span class="math inline">\(x_1\)</span> y <span class="math inline">\(x_2\)</span> y examinamos su relación.</p>
<p>En los ejemplos de arriba, todos los procesos generadores locales estaban determinados. Cuando tenemos tenemos parámetros desconocidos, es necesario estimarlos antes de usar la fórmula de ajuste, y tomar en cuenta la incertidumbre en la estimación.</p>
<p>Podemos ver cómo haríamos esto con modelos bayesianos. En primer lugar, empezamos con el diagrama causal original, y establecemos nuestros modelos locales</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.5.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /home/runner/.cmdstan/cmdstan-2.31.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.31.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mod_agua <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"../src/agua-1.stan"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_agua)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  array[N] real t_maxima;
  array[N] real unidades;
  array[N] real desabasto_agua;
  array[11] real desabasto_sim;
}

transformed data {
    array[N] real logit_desabasto_agua;

    for(i in 1:N){
      logit_desabasto_agua[i] = logit(desabasto_agua[i]);
    }
}
parameters {
  real alpha;
  real beta;
  real alpha_u;
  real beta_t;
  real beta_d;
  real mu_t;
  real&lt;lower=0&gt; sigma_d;
  real&lt;lower=0&gt; sigma_t;
  real&lt;lower=0&gt; sigma_unidades;
}

transformed parameters {
  array[N] real media_unidades;
  array[N] real desabasto_agua_c;

  for(i in 1:N){
    desabasto_agua_c[i] = alpha + beta*(t_maxima[i] - 28);
    media_unidades[i] = alpha_u + beta_t * (t_maxima[i] - 28) + beta_d * desabasto_agua[i];
  }



}
model {
  // modelo de número de temperatura
  t_maxima ~ normal(mu_t + 28, sigma_t);
  sigma_t ~ normal(0, 1);
  mu_t ~ normal(0, 3);
  // modelo de desabasto
  logit_desabasto_agua ~ normal(desabasto_agua_c, sigma_d);
  alpha ~ normal(0, 1);
  beta ~ normal(0, 1);
  sigma_d ~ normal(0, 1);
  // modelo de ventas
  for(i in 1:N){
      unidades[i] ~ normal(10000 * media_unidades[i],
        10000 * sigma_unidades);
  }
  sigma_unidades ~ normal(0, 0.5);
  // iniciales para cantidades no medidas
  alpha_u ~ normal(0, 1);
  beta_t ~ normal(0, 1);
  beta_d ~ normal(0, 1);
}

generated quantities{
  array[11] real unidades_sim;

  for(i in 1:11){
    array[2000] real unidades_sim_1;
    for(k in 1:2000){
      // Extraemos una temperatura
      real t_sim = normal_rng(mu_t + 28, sigma_t);
      // calculamos la media para la temperatura y desabasto
      real media_unidades_sim = alpha_u +
      beta_t * (t_sim - 28) + beta_d * desabasto_sim[i];
      // simulamos unidades
      unidades_sim_1[k] = normal_rng(10000 * media_unidades_sim,
        10000 * sigma_unidades);
    }
   // promediamos si nos interesa el valor esperado de unidades
    unidades_sim[i] = mean(unidades_sim_1);
  }
}</code></pre>
</div>
</div>
<p>Tomamos una muestra simulada como datos para hacer la estimación (de modo que es no es necesario preocuparnos por el ajuste de modelos locales).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">128</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>sim_dias <span class="ot">&lt;-</span> <span class="fu">simular_t</span>(<span class="dv">250</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(sim_dias)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>desabasto_sim <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">t_maxima =</span> sim_dias<span class="sc">$</span>t_maxima,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">unidades =</span> sim_dias<span class="sc">$</span>unidades,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">desabasto_agua =</span> sim_dias<span class="sc">$</span>desabasto_agua,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">desabasto_sim =</span> desabasto_sim)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_agua<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, <span class="at">refresh =</span> <span class="dv">1000</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">init =</span> <span class="fl">0.1</span>, <span class="at">step_size =</span> <span class="fl">0.1</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 5.7 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 5.8 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 5.8 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 5.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 5.8 seconds.
Total execution time: 23.6 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>(<span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">summary</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"alpha_u"</span>, <span class="st">"beta_t"</span>, <span class="st">"beta_d"</span>, <span class="st">"mu_t"</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma_t"</span>, <span class="st">"sigma_d"</span>, <span class="st">"sigma_unidades"</span>))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, median, q5, q95)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
  variable       median      q5   q95
  &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 alpha_u        1.99    1.93   2.06 
2 beta_t         0.205   0.185  0.225
3 beta_d         0.770   0.643  0.897
4 mu_t           0.171  -0.0399 0.388
5 alpha          0.0763 -0.0220 0.177
6 beta           1.02    0.969  1.07 
7 sigma_t        2.07    1.93   2.23 
8 sigma_d        0.972   0.906  1.04 
9 sigma_unidades 0.204   0.191  0.220</code></pre>
</div>
</div>
<p>Donde podemos checar que aproximadamente recuperamos los parámetros originales.</p>
<p>Como explicamos según el concepto de cálculo-do, queremos simular de una distribución distinta para estimar el efecto causal de desabasto sobre unidades vendidas. Para esto utilizamos las simulaciones de nuestro modelo (que ajustamos con datos observacionales), pero en la sección de simulación hacemos un cálculo diferente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>sim_intervenciones <span class="ot">&lt;-</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  ajuste<span class="sc">$</span><span class="fu">draws</span>(<span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">".draw"</span>, <span class="fu">contains</span>(<span class="st">"unidades_sim"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"unidades_sim"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"indice"</span>),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">convert =</span> <span class="cn">TRUE</span>, <span class="at">extra =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">tibble</span>(<span class="at">desabasto =</span> desabasto_sim, <span class="at">indice =</span> <span class="fu">seq_along</span>(desabasto_sim)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>sim_intervenciones <span class="sc">|&gt;</span> <span class="fu">group_by</span>(desabasto) <span class="sc">|&gt;</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_unidades =</span> <span class="fu">mean</span>(value), </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>desabasto, <span class="at">y =</span> media_unidades, </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">ymin =</span> q5, <span class="at">ymax =</span> q95)) <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Esta gráfica puede ser difícil de interpretar, porque puede haber correlación entre los distintos estimadores que estamos presentando.</p>
<p>Para comparar, lo mejor es hacer contrastes. Comparamos con la situación de 0 desabasto, por ejemplo, y calculamos el incremento estimado:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>sim_nivel_0 <span class="ot">&lt;-</span> <span class="fu">filter</span>(sim_intervenciones, desabasto <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw, <span class="at">value_0 =</span> value)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>sim_intervenciones <span class="sc">|&gt;</span> <span class="fu">left_join</span>(sim_nivel_0) <span class="sc">|&gt;</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dif =</span> value <span class="sc">-</span> value_0) <span class="sc">|&gt;</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(desabasto) <span class="sc">|&gt;</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">diferencia_media =</span> <span class="fu">mean</span>(dif), </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">q5 =</span> <span class="fu">quantile</span>(dif, <span class="fl">0.05</span>),</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">q95 =</span> <span class="fu">quantile</span>(dif, <span class="fl">0.95</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>desabasto, <span class="at">y =</span> diferencia_media, </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">ymin =</span> q5, <span class="at">ymax =</span> q95)) <span class="sc">+</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Claramente todos los estimadores están bien separados de 0. Diez puntos porcentuales de incremento en desabasto incrementan las ventas en alrededor de 8 mil unidades.</p>
<hr>
<p>Recordemos que en todos estos ejemplos nos estamos concentrando en la <em>identificación</em> de un efecto causal que nos interesa, así que nos estamos saltando algunos pasos en el proceso de modelación y estimación que en el trabajo usual debemos seguir:</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Modelación y estimadores
</div>
</div>
<div class="callout-body-container callout-body">
<p>El procedimiento general es (<span class="citation" data-cites="rethinking">McElreath (<a href="99-referencias.html#ref-rethinking" role="doc-biblioref">2015</a>)</span>):</p>
<ol type="1">
<li>Definir la cantidad a estimar</li>
<li>Construir un modelo causal gráfico (puede incluir variables no medidas)</li>
<li>Definir un modelo generativo basado en el modelo causal (puede tener parámetros desconocidos, que se estimarán con datos), recorriendo los nodos y definiendo los modelos individuales. Hacer validación a priori.</li>
<li>Definir el cálculo del estimador (por ejemplo, con la fórmula de ajuste)</li>
<li>Ajustar el modelo completo a los datos, hacer validación posterior y calcular el estimador del paso anterior.</li>
</ol>
</div>
</div>
<p>En 2 y 3 está la mayor parte del trabajo. La parte 3 es parte de un curso de estadística bayesiana, y para esta parte usamos un flujo bayesiano de construcción de modelos (ver <a href="https://arxiv.org/abs/2011.01808">aquí</a> o <a href="https://betanalpha.github.io/assets/case_studies/principled_bayesian_workflow.html">aquí</a>).</p>
</section>
<section id="ejemplo-estaturas-versión-1" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="ejemplo-estaturas-versión-1"><span class="header-section-number">3.7</span> Ejemplo: estaturas (versión 1)</h2>
<p>Consideramos el ejemplo donde queremos entender el <strong>efecto de sexo en el peso de personas</strong>. Usaremos los siguientes datos (<span class="citation" data-cites="rethinking">McElreath (<a href="99-referencias.html#ref-rethinking" role="doc-biblioref">2015</a>)</span>), que son datos recolectados de una población particular (Kalahari !Kung San). Tomamos sólo a los adultos (definidos por más de 18 años).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>howell <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"../datos/Howell1.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 544 Columns: 4
── Column specification ────────────────────────────────────────────────────────
Delimiter: ";"
dbl (4): height, weight, age, male

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(howell)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  height weight   age  male
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1   152.   47.8    63     1
2   140.   36.5    63     0
3   137.   31.9    65     0
4   157.   53.0    41     1
5   145.   41.3    51     0
6   164.   63.0    35     1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(howell, <span class="fu">aes</span>(<span class="at">x =</span> height, <span class="at">y =</span> weight, <span class="at">colour =</span> male)) <span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Empezaremos con el siguiente modelo causal:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="st">    S</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="st">    H</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="st">    W </span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="st">    U</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="st">    S -&gt; H</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="st">    S -&gt; W</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="st">    H -&gt; W</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; H</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; W</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="st">{rank = same; S;H}</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-68dc975b903e6c5a1dbe" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-68dc975b903e6c5a1dbe">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n    S\n    H\n    W \n  node [shape = circle]\n    U\n  edge [minlen = 3]\n    S -> H\n    S -> W\n    H -> W\n    U -> H\n    U -> W\n{rank = same; S;H}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<ul>
<li>En primer lugar, tenemos una flecha <span class="math inline">\(H\to W\)</span>. La razón es que podemos pensar en varias intervenciones que afectan el peso pero que no cambian la estatura.</li>
<li>En segundo lugar, <span class="math inline">\(S\)</span> es causa de <span class="math inline">\(H\)</span>, pero también puede afectar directamente peso <span class="math inline">\(W\)</span> junto con la estatura <span class="math inline">\(H\)</span>.</li>
<li><span class="math inline">\(H\)</span> y <span class="math inline">\(W\)</span> pueden tener otras causas comunes no observadas (nutrición por ejemplo), que no influyen en <span class="math inline">\(S\)</span>.</li>
</ul>
<p>Ahora veamos cómo calcular el efecto causal <strong>total</strong> de sexo sobre peso.</p>
<p><em>Podemos ver que no hay ninguna flecha que llegue a <span class="math inline">\(S\)</span>, de modo que para el efecto total no es necesario hacer cirugía ni usar la fórmula de ajuste.</em></p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Condicionando equivocadamente
</div>
</div>
<div class="callout-body-container callout-body">
<p>De hecho, en este ejemplo sería mala idea condicionar a la estatura <span class="math inline">\(H\)</span>, pues cerramos un camino causal por el que <span class="math inline">\(S\)</span> influye en <span class="math inline">\(W\)</span>, y al mismo tiempo abrimos un camino no causal que pasa por <span class="math inline">\(U\)</span>.</p>
</div>
</div>
<p>El análisis detallado de la gráfica es:</p>
<ul>
<li>Existen dos rutas causales de sexo a peso: una que está mediada por la estatura y otra que es efecto directo sobre peso. <strong>No</strong> queremos bloquear condicionando a la estatura <span class="math inline">\(H\)</span>.</li>
<li>Existe una ruta no causal de sexo sobre peso, y es el camino <span class="math inline">\(S\to H \gets U \to W\)</span>. Sin embargo, esta ruta está bloqueada por <span class="math inline">\(H\)</span>, la estatura, que es un colisionador.</li>
</ul>
<p>Comenzamos ahora el proceso de modelado. Excluiremos a <span class="math inline">\(U\)</span> en nuestro modelo, pues no tiene relevancia para la inferencia acerca del efecto total de <span class="math inline">\(S\)</span> sobre <span class="math inline">\(W\)</span>, como discutimos arriba.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Ojo: interpetación de modelos
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nótese que la decisión de excluir de nuestro análisis la variable <span class="math inline">\(U\)</span> sólo tiene sentido si lo que queremos estimar es el efecto total de sexo sobre peso. Esto implica que nuestras estimaciones que corresponden a <span class="math inline">\(H\to W\)</span> <strong>no</strong> tienen interpretación causal. Una estrategia de identificación para un efecto no implica que todo lo que salga de nuestras estimaciones es causal.</p>
</div>
</div>
<p>Empezamos entonces con el modelo de estatura:</p>
<p><span class="math display">\[H|S=s \sim N(m_h, \sigma_h)\]</span> con</p>
<p><span class="math display">\[m_h = \alpha_0 + \alpha_1 s \]</span> Y el modelo de peso:</p>
<p><span class="math display">\[W|S=s,H=h \sim N(m_w, \sigma_w)\]</span> <span class="math display">\[m(s,a,h) = \gamma_0 + \gamma_1 s  + \gamma_2 h\]</span></p>
<p>Lo escribimos en stan:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>mod_1 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">cmdstan_model</span>(<span class="st">"../src/peso-estatura-inferencia-1.stan"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  vector[N]  s;
  vector[N]  h;
  vector[N]  w;

}

transformed data {
  vector[N] h_c;
  real media_h;
  int M;
  // simulaciones
  M = 1000;
  // centrar
  media_h = mean(h);
  h_c = h - mean(h);
}

parameters {
  real alpha_0;
  real alpha_1;
  real gamma_0;
  real gamma_1;
  real gamma_2;
  real&lt;lower=0&gt; sigma_h;
  real&lt;lower=0&gt; sigma_w;
}



transformed parameters {
  vector[N] m_h;
  vector[N] m_w;

  m_h = alpha_0 + alpha_1 * s;
  m_w = gamma_0 + gamma_1 * s + gamma_2 * h_c;

}

model {
  // modelo para estatura
  h ~ normal(m_h, sigma_h);
  alpha_0 ~ normal(150, 30);
  alpha_1 ~ normal(10, 20);
  sigma_h ~ normal(0, 30);

  // modelo para peso
  w ~ normal(m_w, sigma_w);
  gamma_0 ~ normal(50, 30);
  gamma_1 ~ normal(10, 20);
  gamma_2 ~ normal(0, 2);
  sigma_w ~ normal(0, 5);


}
generated quantities {
  real w_mean_male;
  real w_mean_female;
  real dif_male;
  array[M] real w_sim_male;
  array[M] real w_sim_female;

  // simular hombres
  real do_s = 1;
  for(i in 1:M){
    real h_sim_media = alpha_0 + alpha_1 * do_s;
    real h_sim = normal_rng(h_sim_media, sigma_h);
    real w_sim_media = gamma_0 + gamma_1 * do_s + gamma_2 * (h_sim - media_h);
    w_sim_male[i] = normal_rng(w_sim_media, sigma_w);
  }

  do_s = 0;
  for(i in 1:M){
    real h_sim_media = alpha_0 + alpha_1 * do_s;
    real h_sim = normal_rng(h_sim_media, sigma_h);
    real w_sim_media = gamma_0 + gamma_1 * do_s + gamma_2 * (h_sim - media_h);
    w_sim_female[i] = normal_rng(w_sim_media, sigma_w);
  }

  w_mean_male = mean(w_sim_male);
  w_mean_female = mean(w_sim_female);
  dif_male = w_mean_male - w_mean_female;

}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(howell), <span class="at">s=</span> howell<span class="sc">$</span>male, <span class="at">a =</span> howell<span class="sc">$</span>age, </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">h =</span> howell<span class="sc">$</span>height, <span class="at">w =</span> howell<span class="sc">$</span>weight)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_1<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 2.5 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 2.2 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 2.3 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 2.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.3 seconds.
Total execution time: 9.6 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>( <span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>( <span class="st">"dif_male"</span>))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">9999</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, mean, q5, q95) <span class="sc">|&gt;</span> </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="dv">2</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  variable  mean    q5   q95
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 dif_male  6.77  5.73  7.81</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>sims <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> dif_male)) <span class="sc">+</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">40</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Esta es nuestra estimación del diferencia causal promedio de sexo sobre el peso para personas adultas: está aproximadamente entre 5.5 y 8.5 kilos aproximadamente.</p>
<p>Sin embargo, dada la discusión que tuvimos arriba, podemos hacer un modelo más simple para estimar el efecto total, ignorando <span class="math inline">\(W\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>mod_2 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">cmdstan_model</span>(<span class="st">"../src/peso-estatura-inferencia-simple.stan"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_2)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  vector[N]  s;
  vector[N]  w;

}

transformed data {
  vector[N] h_c;
  int M;
  // simulaciones
  M = 1000;
  // centrar

}

parameters {
  real gamma_0;
  real gamma_1;
  real gamma_2;
  real&lt;lower=0&gt; sigma_w;
}



transformed parameters {
  vector[N] m_w;

  m_w = gamma_0 + gamma_1 * s;

}

model {

  // modelo para peso
  w ~ normal(m_w, sigma_w);
  gamma_0 ~ normal(50, 30);
  gamma_1 ~ normal(10, 20);
  gamma_2 ~ normal(0, 2);
  sigma_w ~ normal(0, 5);


}
generated quantities {
  real w_mean_male;
  real w_mean_female;
  real dif_male;
  array[M] real w_sim_male;
  array[M] real w_sim_female;

  // simular hombres
  real do_s = 1;
  for(i in 1:M){
    real w_sim_media = gamma_0 + gamma_1 * do_s;
    w_sim_male[i] = normal_rng(w_sim_media, sigma_w);
  }

  do_s = 0;
  for(i in 1:M){
    real w_sim_media = gamma_0 + gamma_1 * do_s;
    w_sim_female[i] = normal_rng(w_sim_media, sigma_w);
  }

  w_mean_male = mean(w_sim_male);
  w_mean_female = mean(w_sim_female);
  dif_male = w_mean_male - w_mean_female;

}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(howell), <span class="at">s=</span> howell<span class="sc">$</span>male, </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">w =</span> howell<span class="sc">$</span>weight)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_2<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 1.4 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 1.4 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 1.4 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 1.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.4 seconds.
Total execution time: 5.8 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>( <span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>( <span class="st">"dif_male"</span>))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">9999</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, mean, q5, q95) <span class="sc">|&gt;</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="dv">2</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  variable  mean    q5   q95
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 dif_male  6.78  5.76  7.86</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sims <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> dif_male)) <span class="sc">+</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">40</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y obtenemos el mismo resultado con un modelo más simple. El modelo anterior lo usaremos después para explorar el concepto de <em>mediación</em>.</p>
</section>
<section id="bloqueando-puertas-traseras" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="bloqueando-puertas-traseras"><span class="header-section-number">3.8</span> Bloqueando puertas traseras</h2>
<p>En las partes anteriores vimos qué estratificando por los padres de la variable de tratamiento <span class="math inline">\(X\)</span> podíamos construir un estimador del efecto de <span class="math inline">\(X\)</span> sobre otra variable <span class="math inline">\(Y\)</span>, pasando de una distribución observacional a una conceptualmente experimental (dado que nos supuestos causales sean aproximadamente correctos).</p>
<p>Sin embargo, esta aplicación de la fórmula de ajuste no funciona si existen padres que no fueron observados, y por tanto no podemos estratificar por ellos. El siguiente método (ajuste por “puerta trasera”) nos da una técnica adicional que podemos usar dado ciertos tipos de estructura en nuestro modelo causal, y presenta una mejoría sobre la fórmula de ajuste simple (veremos también por ejemplo, que a veces podemos usar menos variables que padres de la variable de interés). Nótese que una vez más, este criterio sólo depende de la gráfica causal <span class="math inline">\(G\)</span> asociada a nuestro modelo, y no los modelos locales que utilizemos para modelar la condicional de cada nodo.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Ajuste de puerta trasera (Pearl)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si tenemos dos variables <span class="math inline">\(T\)</span> y <span class="math inline">\(Y\)</span> en una gráfica <span class="math inline">\(G\)</span>, un conjunto <span class="math inline">\(Z\)</span> de variables satisface el <strong>criterio de puerta trasera</strong> relativo a <span class="math inline">\(T\)</span> y <span class="math inline">\(Y\)</span> cuando <span class="math inline">\(Z\)</span> bloquea cualquier camino entre <span class="math inline">\(T\)</span> y <span class="math inline">\(Y\)</span> que tenga una arista que incida en <span class="math inline">\(T\)</span>, y ninguna variable de <span class="math inline">\(Z\)</span> es descendiente de <span class="math inline">\(T\)</span>.</p>
<p>En tal caso, podemos utilizar la fórmula de ajuste, pero en lugar de estratificar por los padres de <span class="math inline">\(T\)</span>, estratificamos por las variables en <span class="math inline">\(Z\)</span></p>
</div>
</div>
<p>La idea es:</p>
<ol type="1">
<li>Queremos bloquear todos los caminos no causales entre <span class="math inline">\(T\)</span> y <span class="math inline">\(Y\)</span>.</li>
<li>Queremos no perturbar todos los caminos dirigidos de <span class="math inline">\(T\)</span> a <span class="math inline">\(Y\)</span> (caminos causales).</li>
<li>No queremos activar caminos no causales al condicionar.</li>
</ol>
<p>Cumplimos 1 al estratificar por variables que bloquean los caminos que son causas de <span class="math inline">\(T\)</span>, pues estos caminos no son causales y distorsionan la relación entre <span class="math inline">\(T\)</span> y <span class="math inline">\(Y\)</span>. Al mismo tiempo, no bloqueamos caminos causales porque ningúna variable de <span class="math inline">\(Z\)</span> es descendiente de <span class="math inline">\(T\)</span>, de modo que se satisface el criterio 2 (todos los caminos causales comienzan con <span class="math inline">\(T\to\)</span>). Finalmente, nuestro criterio también implica que no condicionamos a colisionadores, pues estos ocurren en caminos de la forma <span class="math inline">\(T\to U_1 \cdots V\gets Y\)</span>, y esto activa caminos entre <span class="math inline">\(T\)</span> y <span class="math inline">\(Y\)</span> que inciden en <span class="math inline">\(T\)</span>.</p>
<section id="ejemplo-pearl-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-pearl-1">Ejemplo (Pearl)</h3>
<p>Consideramos primero este ejemplo simple, donde queremos evaluar la efectividad de un tratamiento en cierta enfermedad. Los datos que tenemos disponibles son si una persona recibió o no un tratamiento, y si se recuperó o no. No se registró el nivel socioeconómico, pero sabemos que el tratamiento es caro, de forma que fue accedido más por gente de NSE más alto. También que sabemos que para este tipo de tratamiento, el peso de la persona es un factor importante. Nuestros supuestos están en la siguiente gráfica:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2, rankdir = LR]</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="st">    Trata</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="st">    Res</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="st">    NSE</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="st">    Peso</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="st">    U</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="st">    NSE -&gt; Peso</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="st">    NSE -&gt; Trata</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="st">    Trata -&gt; Res</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="st">    Peso -&gt; Res</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; NSE</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; Peso</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-bdd0fbbd3894df14bcf0" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-bdd0fbbd3894df14bcf0">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2, rankdir = LR]\n  node [shape=plaintext]\n    Trata\n    Res\n  node [shape = circle]\n    NSE\n    Peso\n    U\n  edge [minlen = 3]\n    NSE -> Peso\n    NSE -> Trata\n    Trata -> Res\n    Peso -> Res\n    U -> NSE\n    U -> Peso\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Observamos que no podemos directamente usar la fórmula de ajuste pues NSE no es una variable observada.</p>
<p>En esta circunstancia no podríamos identificar el efecto causal, pues existen un caminos abiertos no causales. Quizá el tratamiento no es muy efectivo, y parece ser bueno pues fue aplicado a personas con menor peso que las que no recibieron el tratamiento, a través del efecto de NSE. Sin embargo, supón que tuviéramos disponible la variable Peso:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2, rankdir = LR]</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="st">    Trata</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="st">    Res</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="st">    Peso</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="st">    NSE</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="st">    U</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="st">    NSE -&gt; Peso</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="st">    NSE -&gt; Trata</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="st">    Trata -&gt; Res</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="st">    Peso -&gt; Res</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; NSE</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; Peso</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-02a4858ca7f7eae38456" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-02a4858ca7f7eae38456">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2, rankdir = LR]\n  node [shape=plaintext]\n    Trata\n    Res\n    Peso\n  node [shape = circle]\n    NSE\n    U\n  edge [minlen = 3]\n    NSE -> Peso\n    NSE -> Trata\n    Trata -> Res\n    Peso -> Res\n    U -> NSE\n    U -> Peso\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>En este caso, todavía no podemos aplicar la fórmula original de ajuste pues no conocemos <span class="math inline">\(NSE\)</span>. Sin embargo, podemos bloquear los caminos no causales estratificando por Peso, y entonces podemos usar el criterio de puerta trasera para identificar el efecto del tratamiento, aún cuando no tengamos NSE.</p>
</section>
<section id="ejemplo-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-1">Ejemplo</h3>
<p>Primero consideramos un modelo generador:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>simular_bd <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10</span>){</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  nse <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  peso <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">70</span> <span class="sc">-</span> <span class="dv">7</span> <span class="sc">*</span> nse, <span class="dv">12</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> nse)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  trata <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.8</span> <span class="sc">*</span> nse <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> nse))</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  p_trata <span class="ot">&lt;-</span> <span class="fu">inv_logit</span>(<span class="dv">1</span> <span class="sc">*</span> trata <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> (peso <span class="sc">-</span> <span class="dv">70</span>))</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_trata)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(nse, peso, trata, res)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>datos_bd <span class="ot">&lt;-</span> <span class="fu">simular_bd</span>(<span class="dv">10000</span>)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(datos_bd)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
    nse  peso trata   res
  &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt;
1     0  72.6     0     1
2     1  67.8     1     0
3     1  68.8     1     0
4     1  62.2     1     1
5     0  81.3     1     0
6     0  67.6     1     1</code></pre>
</div>
</div>
<p>Veamos qué sucede si cruzamos tratamiento con resultado (es una muestra grande y el error de estimación no es importante):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>datos_bd <span class="sc">|&gt;</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(trata, res) <span class="sc">|&gt;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(trata) <span class="sc">|&gt;</span> </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(res <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dif =</span> p <span class="sc">-</span> <span class="fu">lag</span>(p))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  trata   res     n     p    dif
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     0     1  2609 0.530 NA    
2     1     1  3784 0.746  0.216</code></pre>
</div>
</div>
<p>Sabemos que esta diferencia en respuesta puede estar confundida por un camino no causal. El verdadero efecto casual podemos calcularlo en nuestras simulaciones como sigue a partir de nuestro modelo (igualmente, usamos una muestra muy grande):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>simular_efecto <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">peso =</span> <span class="cn">NULL</span>){</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cómo es la población</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  nse <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(peso)){</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    peso <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">70</span> <span class="sc">-</span> <span class="dv">7</span> <span class="sc">*</span> nse, <span class="dv">12</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> nse)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># asignar al azar</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  trata <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  p_trata <span class="ot">&lt;-</span> <span class="fu">inv_logit</span>(<span class="dv">1</span> <span class="sc">*</span> trata <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> (peso <span class="sc">-</span> <span class="dv">70</span>))</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_trata)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(nse, peso, trata, res)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>sims_efecto <span class="ot">&lt;-</span> <span class="fu">simular_efecto</span>(<span class="dv">20000</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> sims_efecto <span class="sc">|&gt;</span> </span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(trata, res) <span class="sc">|&gt;</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(trata) <span class="sc">|&gt;</span> </span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(res <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dif =</span> p <span class="sc">-</span> <span class="fu">lag</span>(p))</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>dif_real <span class="ot">&lt;-</span> resumen<span class="sc">$</span>dif[<span class="dv">2</span>]</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>resumen</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  trata   res     n     p    dif
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     0     1  5885 0.586 NA    
2     1     1  7013 0.705  0.119</code></pre>
</div>
</div>
<p>La estimación ingenua del cruce simple es mucho más grande que el verdadero efecto.</p>
<p>Podemos también calcular el efecto para un peso particular:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>sims_efecto <span class="ot">&lt;-</span> <span class="fu">simular_efecto</span>(<span class="dv">20000</span>, <span class="at">peso =</span> <span class="dv">70</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>res_70 <span class="ot">&lt;-</span> sims_efecto <span class="sc">|&gt;</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(trata, res) <span class="sc">|&gt;</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(trata) <span class="sc">|&gt;</span> </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(res <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dif =</span> p <span class="sc">-</span> <span class="fu">lag</span>(p))</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>dif_70 <span class="ot">&lt;-</span> res_70<span class="sc">$</span>dif[<span class="dv">2</span>]</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>res_70</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  trata   res     n     p    dif
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     0     1  5028 0.500 NA    
2     1     1  7306 0.734  0.234</code></pre>
</div>
</div>
<p>Suponiendo nuestro diagrama, queremos estimar estratificando por peso. Podríamos usar un sólo modelo logístico, pero pueden ser más simples los cálculos si construimos nuestro modelo en stan. En este caso, podríamos calcular las diferencias para un peso particular, por ejemplo 70 kg (en lugar de modelar estaturas para producir una estimación de diferencia promedio).</p>
<p>Usaremos una muestra de 2 mil personas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>mod_trata <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"../src/trata-backdoor.stan"</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_trata)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  vector[N] trata;
  array[N] int res;
  vector[N] peso;

}

transformed data {
  real media_peso;

  // centrar
  media_peso = mean(peso);
}

parameters {
  real gamma_0;
  real gamma_1;
  real gamma_2;
}

transformed parameters {
  vector[N] p_logit_res;

  p_logit_res = gamma_0 + gamma_1 * trata + gamma_2 * (peso - media_peso);

}

model {
  // modelo de resultado
  res ~ bernoulli_logit(p_logit_res);
  gamma_0 ~ normal(0, 2);
  gamma_1 ~ normal(0, 1);
  gamma_2 ~ normal(0, 0.2);


}
generated quantities {
  real dif_trata;
  real p_trata;
  real p_no_trata;

  real peso_sim = 70;
  {
    array[2000] int res_trata;
    array[2000] int res_no_trata;
    for(k in 1:2000){
      res_trata[k] = bernoulli_rng(
        inv_logit(gamma_0 + gamma_1 * 1 +
              gamma_2 * (peso_sim - media_peso)));
      res_no_trata[k] = bernoulli_rng(
        inv_logit(gamma_0 + gamma_1 * 0 +
              gamma_2 * (peso_sim - media_peso)));
    }
    p_trata = mean(res_trata);
    p_no_trata = mean(res_no_trata);
  }
  dif_trata = p_trata - p_no_trata;
}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">915</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>datos_bd <span class="ot">&lt;-</span> <span class="fu">simular_bd</span>(<span class="dv">2000</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_bd),</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">trata =</span> datos_bd<span class="sc">$</span>trata, <span class="at">res =</span> datos_bd<span class="sc">$</span>res,</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">peso =</span> datos_bd<span class="sc">$</span>peso)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_trata<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 2.6 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 2.7 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 2.6 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 2.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.7 seconds.
Total execution time: 11.0 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>( <span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>( <span class="st">"dif_trata"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, mean, q5, q95)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  variable   mean    q5   q95
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 dif_trata 0.214 0.162 0.268</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>sims <span class="sc">|&gt;</span> <span class="fu">select</span>(dif_trata) <span class="sc">|&gt;</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> dif_trata)) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> dif_70, <span class="at">colour =</span> <span class="st">"red"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y obtenemos una estimación correcta del efecto en 70 kg. Podríamos también calcular el efecto en distintos pesos (nuestro estimador es una curva), promediar estimando una distribución de pesos modelada, o tomar una distribución fija de pesos para modelar (cada una de estas estrategias tiene propósitos diferentes).</p>
<p>Si queremos tener un efecto promedio, podemos modelar los pesos. Otra estrategia es promediar sobre los valores observados de la muestra. Nótese que esto ignora una parte de la incertidumbre proveniente de la muestra particular usada (aunque podríamos usar bootstrap para incluir esta incertidumbre adicional):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>mod_trata <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"../src/trata-backdoor-promedio.stan"</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_trata)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  vector[N] trata;
  array[N] int res;
  vector[N] peso;

}

transformed data {
  real media_peso;

  // centrar
  media_peso = mean(peso);
}

parameters {
  real gamma_0;
  real gamma_1;
  real gamma_2;
}

transformed parameters {
  vector[N] p_logit_res;

  p_logit_res = gamma_0 + gamma_1 * trata + gamma_2 * (peso - media_peso);

}

model {
  // modelo de resultado
  res ~ bernoulli_logit(p_logit_res);
  gamma_0 ~ normal(0, 2);
  gamma_1 ~ normal(0, 1);
  gamma_2 ~ normal(0, 0.2);


}
generated quantities {
  real dif_trata;
  real p_trata;
  real p_no_trata;
  vector[N] probs;

  for(i in 1:N){
    probs[i] = 1.0 / N;
  }

  {
    array[2000] int res_trata;
    array[2000] int res_no_trata;
    for(k in 1:2000){
      real peso_sim = peso[categorical_rng(probs)];
      res_trata[k] = bernoulli_rng(
        inv_logit(gamma_0 + gamma_1 * 1 +
              gamma_2 * (peso_sim - media_peso)));
      res_no_trata[k] = bernoulli_rng(
        inv_logit(gamma_0 + gamma_1 * 0 +
              gamma_2 * (peso_sim - media_peso)));
    }
    p_trata = mean(res_trata);
    p_no_trata = mean(res_no_trata);
  }
  dif_trata = p_trata - p_no_trata;

}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_bd),</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trata =</span> datos_bd<span class="sc">$</span>trata, <span class="at">res =</span> datos_bd<span class="sc">$</span>res,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">peso =</span> datos_bd<span class="sc">$</span>peso)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_trata<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 15.3 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 15.6 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 15.5 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 15.5 seconds.

All 4 chains finished successfully.
Mean chain execution time: 15.4 seconds.
Total execution time: 62.1 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"dif_trata"</span>), <span class="at">format =</span> <span class="st">"df"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>( <span class="st">"dif_trata"</span>))</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, mean, q5, q95)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  variable   mean     q5   q95
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 dif_trata 0.110 0.0785 0.141</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>sims <span class="sc">|&gt;</span> <span class="fu">select</span>(dif_trata) <span class="sc">|&gt;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> dif_trata)) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> dif_real, <span class="at">colour =</span> <span class="st">"red"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y recuperamos nuevamente el efecto verdadero que mostramos arriba.</p>
</section>
</section>
<section id="reglas-del-cálculo-do-opcional" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="reglas-del-cálculo-do-opcional"><span class="header-section-number">3.9</span> Reglas del cálculo-do (opcional)</h2>
<p>Existen tres axiomas básicos del cálculo-do de las que se derivan los demás resultados, como veremos en el siguiente ejemplo del criterio de la puerta delantera.</p>
<p>Antes de verlas, un resumen rápido de las reglas es el siguiente:</p>
<ul>
<li><p>La regla 1 nos dice que las distribuciones asociadas a intervenciones satisfacen también la equivalencia de <span class="math inline">\(d\)</span>-separación e independencia condicional (si condicionamos y <span class="math inline">\(Z\)</span> y <span class="math inline">\(Y\)</span> están <span class="math inline">\(d\)</span> separadas).</p></li>
<li><p>La regla 2 es el criterio de la puerta trasera.</p></li>
<li><p>La regla 3 expresa que si no hay caminos causales de <span class="math inline">\(X\)</span> a <span class="math inline">\(Y\)</span>, entonces <span class="math inline">\(p(y|do(x)) = p(y)\)</span>.</p></li>
</ul>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Completitud (Shpitser, Pearl)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si un efecto causal es identificable (puede expresarse en términos de cantidades observacionales), entonces puede derivarse una estrategia de identificación a partir de las tres reglas del cálculo-do.</p>
</div>
</div>
<p>Con más generalidad, abajo están estas reglas (donde condicionamos a más variables o hacemos más intervenciones, y afinamos las condiciones):</p>
<p>Denotamos por <span class="math inline">\(G_m\)</span> la gráfica mutilada por <span class="math inline">\(do(x)\)</span>, donde quitamos todas las aristas que entran en <span class="math inline">\(X\)</span>. Los tres axiomas son:</p>
<p><strong>Regla 1</strong> Ignorar observaciones: Si <span class="math inline">\(Y\)</span> y <span class="math inline">\(Z\)</span> están <span class="math inline">\(d\)</span>-separados por <span class="math inline">\(X\)</span> y <span class="math inline">\(W\)</span> en <span class="math inline">\(G_m\)</span>,</p>
<p><span class="math display">\[ p(y|do(x), z, w) = p(y|do(x), w)\]</span> O en otras palabras, si <span class="math inline">\(p_m\)</span> es la conjunta para <span class="math inline">\(G_m\)</span>,</p>
<p><span class="math display">\[p_m(y|x,z,w) = p_m(y|x, w)\]</span> es cierto si <span class="math inline">\(Y\)</span> y <span class="math inline">\(Z\)</span> están <span class="math inline">\(d\)</span>-separados por <span class="math inline">\(X\)</span> y <span class="math inline">\(W\)</span> en <span class="math inline">\(G_m\)</span> (condicionalmente independientes). Así que esta regla es independencia condicional dado <span class="math inline">\(d\)</span>-separación, pero para la gráfica intervenida.</p>
<p><strong>Regla 2</strong> Usando observaciones como intervenciones:</p>
<p>Si <span class="math inline">\(Y\)</span> y <span class="math inline">\(Z\)</span> están <span class="math inline">\(d\)</span>-separados por <span class="math inline">\(X\)</span> y <span class="math inline">\(W\)</span> en <span class="math inline">\(G_m\)</span> quitándole todas las aristas que salen de <span class="math inline">\(Z\)</span>, entonces</p>
<p><span class="math display">\[ p(y|do(x), do(z), w) = p(y|do(x), z, w)\]</span> Esta es como el criterio de ajuste por puerta trasera, y reescribimos como:</p>
<p><span class="math display">\[ p_m(y|do(z), x, w) = p_m(y|z, x, w)\]</span> Para que podamos sustituir <span class="math inline">\(z\)</span> en lugar de <span class="math inline">\(do(z)\)</span> requerimos que, dado <span class="math inline">\(W\)</span>, no haya caminos activos de puerta trasera de <span class="math inline">\(Z\)</span> a <span class="math inline">\(Y\)</span> en <span class="math inline">\(G_m\)</span>. Por lo tanto, basta examinar la gráfica donde quitamos de <span class="math inline">\(G_m\)</span> las aristas que salen de <span class="math inline">\(Z\)</span>, que no pueden crear puertas traseras. Si <span class="math inline">\(Y\)</span> y <span class="math inline">\(Z\)</span> están <span class="math inline">\(d\)</span>-separados por <span class="math inline">\(W\)</span> y <span class="math inline">\(X\)</span> en esta nueva gráfica, no hay caminos de puerta trasera y podemos sustituir <span class="math inline">\(do(z)\)</span> por <span class="math inline">\(z\)</span>.</p>
<p><strong>Regla 3</strong> Ignorar intervenciones:</p>
<p>Si <span class="math inline">\(Z\)</span> y <span class="math inline">\(Y\)</span> están <span class="math inline">\(d\)</span>-separadas por <span class="math inline">\(X\)</span> y <span class="math inline">\(W\)</span> en la gráfica <span class="math inline">\(G_m\)</span> donde además quitamos cualquier arista a <span class="math inline">\(Z\)</span> si <span class="math inline">\(Z\)</span> no es antecesor de <span class="math inline">\(W\)</span> en <span class="math inline">\(G_m\)</span>.</p>
<p>Entonces:</p>
<p><span class="math display">\[ p(y|do(x), do(z), w) = p(y|do(x), w)\]</span> Quitando el operador <span class="math inline">\(do(x)\)</span>:</p>
<p><span class="math display">\[p_m(y|do(z), x, w) = p_m(y|x, w)\]</span></p>
<p>Consideramos dos casos:</p>
<p>Si <span class="math inline">\(Z\)</span> es antecesor de <span class="math inline">\(W\)</span>, y <span class="math inline">\(Y\)</span> y <span class="math inline">\(Z\)</span> están <span class="math inline">\(d\)</span>-separados en <span class="math inline">\(G_m\)</span>, entonces condicionar por <span class="math inline">\(W\)</span>, por <span class="math inline">\(d\)</span>-separación tenemos:</p>
<ul>
<li>Si hay rutas causales de <span class="math inline">\(Z\)</span> a <span class="math inline">\(Y\)</span>, estas son bloqueadas por <span class="math inline">\(W\)</span>.</li>
<li>No puede abrir ninguna ruta si hay colisión en <span class="math inline">\(W\)</span>.</li>
</ul>
<p>Así que cualquier manipulación de <span class="math inline">\(Z\)</span> no tiene efecto en la distribución de <span class="math inline">\(Y\)</span>.</p>
<p>Si <span class="math inline">\(Z\)</span> no es antecesor de <span class="math inline">\(W\)</span>, y <span class="math inline">\(Y\)</span> y <span class="math inline">\(Z\)</span> están <span class="math inline">\(d\)</span>-separados en <span class="math inline">\(G_m\)</span> menos las aristas que llegan a <span class="math inline">\(Z\)</span>, condicionar por <span class="math inline">\(W\)</span>, por <span class="math inline">\(d\)</span>-separación tenemos:</p>
<ul>
<li>No puede haber rutas causales de <span class="math inline">\(Z\)</span> a <span class="math inline">\(Y\)</span> (pues ninguna de ellas llega a <span class="math inline">\(Z\)</span>)</li>
<li>No puede abrir ninguna ruta por colisión en <span class="math inline">\(W\)</span> (pues <span class="math inline">\(W\)</span> tendría que ser descendiente de <span class="math inline">\(Z\)</span>).</li>
</ul>
<p>Así que cualquier manipulación de <span class="math inline">\(Z\)</span> no tienen efecto en la distribución de <span class="math inline">\(Y\)</span></p>
</section>
<section id="el-criterio-de-puerta-delantera" class="level2" data-number="3.10">
<h2 data-number="3.10" class="anchored" data-anchor-id="el-criterio-de-puerta-delantera"><span class="header-section-number">3.10</span> El criterio de puerta delantera</h2>
<p>En algunos casos, puede ser que no sea posible bloquear algún camino no causal con variables observadas. Un ejemplo clásico es el de la discusión acerca de la relación de fumar con cáncer de pulmón. Algunos estadísticos plantearon que los estudios de asociación entre fumar y cáncer de pulmón podrían tener efectos gravemente confundidos, por ejemplo, por aspectos genéticos que hacen a una persona propensa a fumar al mismo tiempo que aumenta su probabilidad de fumar:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="st">    F</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="st">    C</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="st">    U</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; F</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; C</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="st">    F -&gt; C</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="st">{rank= same; C; F}</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-d41d00aabf31124e4754" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-d41d00aabf31124e4754">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n    F\n    C\n  node [shape = circle]\n    U\n  edge [minlen = 3]\n    U -> F\n    U -> C\n    F -> C\n{rank= same; C; F}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>En este caso, el efecto de fumar (<span class="math inline">\(F\)</span>) sobre cáncer (<span class="math inline">\(C\)</span>) no es identificable pues no podemos condicionar a la variable de Genotipo (<span class="math inline">\(U\)</span>). Supongamos que tenemos una medida adicional, que es la cantidad de depósitos de alquitrán den los pulmones de los pacientes. Este es es afectado por <span class="math inline">\(F\)</span>, y a su vez, el alquitrán incrementa la probabilidad de cáncer:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="st">    F</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="st">    C</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="st">    A</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="st">    U</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; F</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; C</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="st">    F -&gt; A</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a><span class="st">    A -&gt; C</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="st">{rank= same; C; F; A}</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-4004e77b49dd7cdc9b0e" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-4004e77b49dd7cdc9b0e">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n    F\n    C\n    A\n  node [shape = circle]\n    U\n  edge [minlen = 3]\n    U -> F\n    U -> C\n    F -> A\n    A -> C\n{rank= same; C; F; A}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>La idea es primero estimar el efecto de <span class="math inline">\(F\)</span> sobre <span class="math inline">\(A\)</span>, y después estimar el efecto de <span class="math inline">\(A\)</span> sobre <span class="math inline">\(C\)</span>. La “composición” de estos dos efectos, dado el diagrama, debe darnos el estimador correcto. Primero consideramos el efecto de <span class="math inline">\(F\)</span> sobre <span class="math inline">\(A\)</span>, y tenemos que (regla 2)</p>
<p><span class="math display">\[p(a|do(f)) = p(a|f),\]</span> La igualdad se debe a que una vez que condicionamos a <span class="math inline">\(F\)</span> no hay puertas traseras entre <span class="math inline">\(F\)</span> y <span class="math inline">\(A\)</span> (pues no condicionamos a <span class="math inline">\(C\)</span>). Esta dependencia causal la podemos entonces estimar de los datos.</p>
<p>El efecto de <span class="math inline">\(A\)</span> sobre <span class="math inline">\(C\)</span> también es identificable, pues el camino no causal se bloquea cuando condicionamos a <span class="math inline">\(A\)</span>, de forma que por la fórmula de ajuste:</p>
<p><span class="math display">\[p(c|do(a)) = \int p(c|a, f') p(f')\, df'\]</span></p>
<p>Ahora encadenamos estas dos ecuaciones:</p>
<p><span class="math display">\[p(c|do(f)) = \int p(c|do(a))p(a|f)\,da\]</span></p>
<p>que equivale en simulación a: dado un valor de <span class="math inline">\(F\)</span>, simulamos <span class="math inline">\(A=a\)</span> con nuestro modelo ajustado con datos naturales. Ahora intervenimos <span class="math inline">\(A\)</span> con el valor a que obtuvimos y simulamos <span class="math inline">\(C\)</span>. Sin embargo, para hacer este último paso con datos naturales, necesitamos usar el criterio de puerta trasera como explicamos arriba: simulamos entonces <span class="math inline">\(f´\)</span> de <span class="math inline">\(p(f)\)</span>, y después simulamos <span class="math inline">\(C\)</span> en función de <span class="math inline">\(a\)</span> y <span class="math inline">\(f´\)</span> (con una distribución construida a partir de datos).</p>
<p>Requerimos en este caso construir y estimar la condicional <span class="math inline">\(p(c|a, f)\)</span> basado en los datos.</p>
<p>En fórmula, en general, se escribe como:</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Criterio de fuerta delantera (Pearl)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Decimos que un conjunto de variables <span class="math inline">\(A\)</span> satisface el criterio de puerta delantera en relación a las variables <span class="math inline">\(F\)</span> y <span class="math inline">\(C\)</span> cuando:</p>
<ol type="1">
<li><span class="math inline">\(A\)</span> intercepta todos las cadenas dirigidos de <span class="math inline">\(F\)</span> a <span class="math inline">\(C\)</span></li>
<li>No hay ningún camino activo de puerta trasera de <span class="math inline">\(F\)</span> a <span class="math inline">\(A\)</span></li>
<li>Todos los caminos de puerta trasera de <span class="math inline">\(A\)</span> a <span class="math inline">\(C\)</span> están bloqueados por <span class="math inline">\(F\)</span>.</li>
</ol>
<p>Si <span class="math inline">\(A\)</span> satisface el criterio de puerta delantera en relación a <span class="math inline">\(F\)</span> y <span class="math inline">\(C\)</span>, entonces el efecto causal de <span class="math inline">\(F\)</span> en <span class="math inline">\(C\)</span> es identificable y está dado por la fórmula:</p>
<p><span class="math display">\[p(c|do(f)) = \int \left [ \int p(c|a,f´)p(f´)\,df´ \right ] p(a|f)\,da\]</span></p>
</div>
</div>
<p>Todas estas cantidades puede estimarse de los datos.</p>
<section id="ejemplo-proceso-generador" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-proceso-generador">Ejemplo: proceso generador</h3>
<p>Antes de aplicar este nuevo procedimiento, describamos el proceso generador que utilizaremos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simular distribución natural</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>simular_fd <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">efecto_a =</span> <span class="fl">0.3</span>){</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## causa común</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cantidad que fuma</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(n, <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> u, <span class="fl">0.1</span>))</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># acumulación de alquitrán</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,  <span class="dv">4</span> <span class="sc">*</span> f, <span class="dv">2</span>)</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># probabilidad de cancer</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  p_c <span class="ot">&lt;-</span> <span class="fu">inv_logit</span>(<span class="sc">-</span><span class="dv">6</span> <span class="sc">+</span> efecto_a <span class="sc">*</span> a <span class="sc">+</span>  <span class="dv">2</span> <span class="sc">*</span> u)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_c)</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(f, a, c, u)</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="co"># simular datos intervenidos (suponiendo que conocemos todo)</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>sim_int_f <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">do_f =</span> <span class="fl">0.3</span>, <span class="at">efecto_a =</span> <span class="fl">0.3</span>){</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,  <span class="dv">4</span> <span class="sc">*</span> do_f, <span class="dv">2</span>)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>  p_c <span class="ot">&lt;-</span>  <span class="fu">inv_logit</span>(<span class="sc">-</span><span class="dv">6</span> <span class="sc">+</span> efecto_a <span class="sc">*</span> a <span class="sc">+</span>  <span class="dv">2</span> <span class="sc">*</span> u)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p_c)</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">do_f =</span> do_f, <span class="at">media_c =</span> <span class="fu">mean</span>(c))</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4481</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>sims_fd <span class="ot">&lt;-</span> <span class="fu">simular_fd</span>(<span class="dv">5000</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>sims_fd_1 <span class="ot">&lt;-</span> <span class="fu">simular_fd</span>(<span class="dv">10000</span>)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>(sims_fd<span class="sc">$</span>f, sims_fd<span class="sc">$</span>a)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `qplot()` was deprecated in ggplot2 3.4.0.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>¿Cómo se ve la relación de fumador con cáncer? En esta gráfica mostramos también el valor de la variable no observada <span class="math inline">\(U\)</span>. Nótese que parte de la correlación positiva que existe es debido a esta variable <span class="math inline">\(U\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sims_fd, <span class="fu">aes</span>(<span class="at">x =</span> f, <span class="at">y =</span> c, <span class="at">colour =</span> u)) <span class="sc">+</span> </span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>() <span class="sc">+</span> <span class="fu">scale_colour_continuous</span>(<span class="at">type =</span> <span class="st">"viridis"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ahora veamos cómo se ve el efecto de <span class="math inline">\(F\)</span> sobre <span class="math inline">\(C\)</span> y también cómo se ve el cruce de <span class="math inline">\(F\)</span> y <span class="math inline">\(C\)</span> en los datos naturales:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>sims_1 <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="fl">0.5</span>), <span class="sc">~</span> <span class="fu">sim_int_f</span>(<span class="dv">100000</span>, .x))</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>sims_1 <span class="sc">|&gt;</span> </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> do_f, <span class="at">y =</span> media_c)) <span class="sc">+</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> sims_fd_1, <span class="fu">aes</span>(<span class="at">x =</span> f, <span class="at">y =</span> c), <span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">span =</span> <span class="fl">0.3</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span><span class="st">"red"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Grado de tabaquismo"</span>) <span class="sc">+</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 376 rows containing non-finite values (`stat_smooth()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>En efecto causal promedio de fumar, en cada nivel, sobre la incidencia de cáncer de pulmón, suponiendo nuestro proceso generador. Nótese que la relación no es tan fuerte como observamos en los datos naturales (en rojo). Esto se debe a que en los datos naturales, las personas existe una causa común entre no fumar y prevenir cáncer de pulmón.</p>
</section>
<section id="ejemplo-estimación-con-puerta-delantera" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-estimación-con-puerta-delantera">Ejemplo: estimación con puerta delantera</h3>
<p>Veamos cómo sería la estimación si tuviéramos datos disponible, y si es que podemos recuperar el efecto correcto dados los datos observados y la técnica de puerta delantera.</p>
<p>Nótese que sólo necesitamos $p(c|a, f), p(a|f) y <span class="math inline">\(p(f)\)</span>. Estos son modelos <em>estadístico</em> con el que podemos identificar el efecto que nos interesa. Una vez que los estimemos, podemos usar simulación:</p>
<ol start="0" type="1">
<li>Fijamos una <span class="math inline">\(f\)</span>.</li>
<li>Simulamos una <span class="math inline">\(a\)</span> del modelo <span class="math inline">\(p(a|f)\)</span></li>
<li>Para calcular <span class="math inline">\(\int p(c|a,f')p(f')\)</span>, tenemos que simular un valor <span class="math inline">\(f'\)</span> de la marginal de <span class="math inline">\(p(f)\)</span>, y luego, sustituir junto la <span class="math inline">\(a\)</span> de 1 para simular una <span class="math inline">\(c\)</span> de <span class="math inline">\(p(c|a, f')\)</span>.</li>
<li>Consideramos solamente <span class="math inline">\(c\)</span> y <span class="math inline">\(f\)</span> para resumir el efecto.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">481</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>sims_fd <span class="ot">&lt;-</span> <span class="fu">simular_fd</span>(<span class="dv">2000</span>)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>mod_front_door <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"../src/front-door-2.stan"</span>)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_front_door)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; n_f;
  vector[N] f;
  vector[N]  a;
  array[N]  int&lt;lower=0, upper=1&gt; c;
  array[n_f] real do_f;

}

transformed data {
  real media_a;
  real media_f;

  media_a = mean(a);
  media_f = mean(f);
}

parameters {
  real&lt;lower=0&gt; alpha;
  real alpha_a;
  real&lt;lower=0&gt; alpha_f;
  real int_a;
  real beta_0;
  real&lt;lower=0&gt; beta_1;
  real&lt;lower=0&gt; beta;
  real&lt;lower=0&gt; a_f;
  real&lt;lower=0&gt; b_f;
  real&lt;lower=0&gt; sigma_a;
  real&lt;lower=0&gt; sigma_f;

}



transformed parameters {


}

model {
  f ~ gamma(a_f, b_f);
  a ~ normal(beta * f, sigma_a);
  c ~ bernoulli_logit(int_a + alpha_a * a + alpha_f * f);
  alpha_a ~ normal(0, 1);
  alpha_f ~ normal(0, 1);
  int_a ~ normal(0, 3);
  sigma_a ~ normal(0, 1);
  sigma_f ~ normal(0, 0.1);
  alpha ~ normal(0, 1);
  beta ~ normal(0, 1);
  beta_0 ~ normal(0, 3);
  beta_1 ~ normal(0, 1);

}
generated quantities {
  array[n_f] real mean_c;

  for(i in 1:n_f){
    array[2000] real res_sim;
    for(j in 1:2000){
      real a_sim = normal_rng(beta * (do_f[i]), sigma_a);
      real f_sim = gamma_rng(a_f, b_f);
      res_sim[j] = bernoulli_rng(inv_logit(int_a + alpha_a * a_sim + alpha_f * f_sim));
    }
    mean_c[i] = mean(res_sim);
  }

}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>do_f <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="fl">0.1</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>n_f <span class="ot">&lt;-</span> <span class="fu">length</span>(do_f)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> mod_front_door<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(sims_fd),</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">f =</span> sims_fd<span class="sc">$</span>f, <span class="at">a =</span> sims_fd<span class="sc">$</span>a,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">c =</span> sims_fd<span class="sc">$</span>c, <span class="at">do_f =</span> do_f, <span class="at">n_f =</span> n_f),</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">init =</span> <span class="fl">0.01</span>, <span class="at">step_size =</span> <span class="fl">0.01</span>, </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>,</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 79.9 seconds.
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 82.5 seconds.
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 82.8 seconds.
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 84.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 82.3 seconds.
Total execution time: 84.2 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>sims_efecto_tbl <span class="ot">&lt;-</span> sims<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"mean_c"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"mean_c"</span>), <span class="at">values_to =</span> <span class="st">"media_c"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="fu">c</span>(<span class="st">"nom"</span>, <span class="st">"id"</span>), </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="at">convert =</span> <span class="cn">TRUE</span>, <span class="at">extra =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">tibble</span>(<span class="at">f =</span> do_f) <span class="sc">|&gt;</span> </span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">seq_along</span>(f))) </span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>resumen_tbl <span class="ot">&lt;-</span> sims_efecto_tbl <span class="sc">|&gt;</span> </span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id, f) <span class="sc">|&gt;</span> </span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(media_c), </span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">q5 =</span> <span class="fu">quantile</span>(media_c, <span class="fl">0.05</span>),</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">q95 =</span> <span class="fu">quantile</span>(media_c, <span class="fl">0.95</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(resumen_tbl) <span class="sc">+</span> </span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">x=</span> f, <span class="at">ymax =</span> q95, <span class="at">ymin =</span> q5), <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> f, <span class="at">y =</span> media), <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> sims_1, <span class="fu">aes</span>(<span class="at">x =</span> do_f, <span class="at">y =</span> media_c)) <span class="sc">+</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nivel de tabaquismo"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Prop afectada"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y parece que hemos obtenido una estimación razonable del efecto causal de fumar sobre cáncer. Recordemos también que debemos ser cuidadosos al comparar intervalos que salen del mismo modelo por su nivel de traslape.</p>
<p>Por ejemplo, si quisiéramos calcular contrastes con el nivel 2 de tabaquismo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>efecto_2 <span class="ot">&lt;-</span> sims_efecto_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(f <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.draw, <span class="at">efecto_2 =</span> media_c)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>comp_tbl <span class="ot">&lt;-</span> <span class="fu">left_join</span>(sims_efecto_tbl, efecto_2) <span class="sc">|&gt;</span> </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dif_2 =</span> media_c <span class="sc">-</span> efecto_2)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = ".draw"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>comp_tbl <span class="sc">|&gt;</span> <span class="fu">group_by</span>(f) <span class="sc">|&gt;</span> </span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(dif_2), <span class="at">q5 =</span> <span class="fu">quantile</span>(dif_2, <span class="fl">0.05</span>),</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">q95 =</span> <span class="fu">quantile</span>(dif_2, <span class="fl">0.95</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">x=</span> f, <span class="at">ymax =</span> q95, <span class="at">ymin =</span> q5)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> f, <span class="at">y =</span> media))  <span class="sc">+</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nivel de tabaquismo"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Prop afectada"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Nota</strong>: nótese como en este ejemplo hemos evitado incluir en nuestro modelo la variable no observada <span class="math inline">\(U\)</span>, gracias al procedimiento de puerta delantera descrito arriba.</p>
<p>Es posible sin embargo intentar un modelo completo bayesiano, sin necesidad de recordar la fórmula. El procedimiento, que es más difícil de ajustar: considera una variable latente <span class="math inline">\(U\)</span> no observada, y es necesario definir cómo puede ser su relación con sus descendientes. Es necesario más cuidado en definir formas funcionales e iniciales apropiadas para que los muestreadores funcionen apropiadamente.</p>
</section>
</section>
<section id="mediación-y-datos-de-berkeley" class="level2" data-number="3.11">
<h2 data-number="3.11" class="anchored" data-anchor-id="mediación-y-datos-de-berkeley"><span class="header-section-number">3.11</span> Mediación y datos de Berkeley</h2>
<p>Cuando existen distintas rutas causales entre una variable que intervenimos y un resultado, muchas veces es relevante intentar separar los efectos directos del tratamiento de aquellos que están mediados por otras variables.</p>
<p>En general, entender separar efectos directos o mediados requiere más supuestos que entender efectos totales sobre todas las posibles rutas causales.</p>
<section id="ejemplo-admisiones-de-berkeley" class="level3" data-number="3.11.1">
<h3 data-number="3.11.1" class="anchored" data-anchor-id="ejemplo-admisiones-de-berkeley"><span class="header-section-number">3.11.1</span> Ejemplo: Admisiones de Berkeley</h3>
<p>En 1973 se recolectaron datos agregados de solicitantes para estudiar en Berkeley para los 6 departamentos más grandes, clasificados por sexo del solicitante y si fue admitido o no. Los resultados se muestran a continuación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"UCBAdmissions"</span>)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>adm_original <span class="ot">&lt;-</span> UCBAdmissions <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Admit, <span class="at">values_from =</span> n) </span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>adm_indiv <span class="ot">&lt;-</span> UCBAdmissions <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Gender =</span> <span class="fu">ifelse</span>(Gender<span class="sc">==</span><span class="st">"Female"</span>, <span class="dv">2</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Dept =</span> <span class="fu">factor</span>(Dept) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Admit =</span> <span class="fu">ifelse</span>(Admit <span class="sc">==</span> <span class="st">"Admitted"</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">uncount</span>(n)</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>adm_indiv <span class="sc">|&gt;</span> <span class="fu">head</span>() </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  Admit Gender  Dept
  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
1     1      1     1
2     1      1     1
3     1      1     1
4     1      1     1
5     1      1     1
6     1      1     1</code></pre>
</div>
</div>
<p>Comenzaremos construyendo nuestro modelo causal:</p>
<ul>
<li>Género es una causa con el departamento que seleccionan los aplicantes, en primer lugar porque ya sea por educación o otras razones distintos géneros prefieren distintas carreras</li>
<li>Los departamentos también son una causa de aceptación de aplicantes. Algunos departamentos tienen más aplicantes o menos capacidad, y los que deciden son diferentes personas.</li>
<li>Consideramos que Género también puede ser una causa directa de admisión, y puede haber favoritismo por algún género.</li>
</ul>
<p>Nuestro primer diagrama, <em>que criticaremos más adelante</em>, se ve cómo sigue:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="st">    G</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="st">    D</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="st">    A </span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="st">  #node [shape = circle]</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="st">  #  U</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a><span class="st">    G -&gt; D</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a><span class="st">    G -&gt; A</span></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a><span class="st">    D -&gt; A</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a><span class="st">{rank = same; G;A}</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-845fef1451781f8c8f5f" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-845fef1451781f8c8f5f">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n    G\n    D\n    A \n  #node [shape = circle]\n  #  U\n  edge [minlen = 3]\n    G -> D\n    G -> A\n    D -> A\n{rank = same; G;A}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Bajo estos supuestos, podemos calcular el efecto total de género en admisiones: para esto es importante <strong>no</strong> condicionar a departamento. Nuestro modelo es el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>mod_1_berkeley <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"../src/berkeley-1.stan"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(adm_indiv), <span class="at">n_d =</span> <span class="dv">6</span>,</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">admit =</span> adm_indiv<span class="sc">$</span>Admit, <span class="at">gender =</span> adm_indiv<span class="sc">$</span>Gender,</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dept =</span> adm_indiv<span class="sc">$</span>Dept)</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_1_berkeley<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, </span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">iter_warmup =</span> <span class="dv">200</span>, <span class="at">iter_sampling =</span> <span class="dv">500</span>,</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">refresh =</span> <span class="dv">1000</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 2 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 3 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 4 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 4 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 3 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 1 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 2 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 4 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 4 finished in 135.9 seconds.
Chain 3 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 3 finished in 140.9 seconds.
Chain 2 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 2 finished in 144.2 seconds.
Chain 1 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 1 finished in 144.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 141.4 seconds.
Total execution time: 144.7 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>resumen_mod <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, mean, q5, q95)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>resumen_mod</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 29 × 4
   variable          mean          q5          q95
   &lt;chr&gt;            &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
 1 lp__      -13086.      -13092.     -13081.     
 2 beta_0        -0.383       -0.432      -0.334  
 3 beta[1,1]      0.687        0.0473      1.32   
 4 beta[2,1]     -0.652       -1.31        0.00402
 5 beta[1,2]      0.300       -0.343       0.938  
 6 beta[2,2]     -2.06        -2.75       -1.33   
 7 beta[1,3]     -0.243       -0.884       0.395  
 8 beta[2,3]      1.05         0.388       1.69   
 9 beta[1,4]      0.00421     -0.630       0.645  
10 beta[2,4]      0.587       -0.0775      1.24   
# … with 19 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>sims_contraste <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"contraste_m_h"</span>, <span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sims_contraste, <span class="fu">aes</span>(<span class="at">x =</span> contraste_m_h)) <span class="sc">+</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y nuestra conclusión aquí es que el efecto total de género sobre admisión favorece a los hombres, y la diferencia es entre 20 y 8 puntos porcentuales aproximadamente.</p>
<p>Sin embargo, en este ejemplo vale la pena entender que estamos estimando el efecto de dos caminos causales (ver McElreath, Statistical Rethinking):</p>
<ul>
<li>Posible discriminación directa general porque una aplicación está identificada como “mujer”. Este es un efecto directo, lo que más propiamente llamaríamos discriminación de personas.</li>
<li>Posible discriminación estructural por las carreras que escogen las personas. En este caso, quizá por ejemplo los departamentos de ingeniería son más fáciles, pero tradicionalmente no se alienta a las mujeres escoger ese tipo de carreras. Este efecto está mediado por la selección de departamento.</li>
<li>El efecto total es el que experimentan las personas, por cualquiera de las dos razones de arriba.</li>
</ul>
<p>Cada una de estas razones son muy diferentes y llevan a distintas conclusiones acerca de los datos. Veremos ahora cómo, bajo el modelo que tenemos ahora, podemos intentar estimar el efecto directo de discriminación. En este caso, <em>necesitamos bloquear la variable departamento</em>, para ver sólo el efecto directo, y esto lo logramos estratificando por departamento.</p>
<p>El modelo no cambia, pero simulamos diferente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>mod_2_berkeley <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"../src/berkeley-2.stan"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(adm_indiv), <span class="at">n_d =</span> <span class="dv">6</span>,</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">admit =</span> adm_indiv<span class="sc">$</span>Admit, <span class="at">gender =</span> adm_indiv<span class="sc">$</span>Gender,</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dept =</span> adm_indiv<span class="sc">$</span>Dept)</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_2_berkeley<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, </span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">iter_warmup =</span> <span class="dv">200</span>, <span class="at">iter_sampling =</span> <span class="dv">500</span>,</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">refresh =</span> <span class="dv">1000</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 2 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 3 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 4 Iteration:   1 / 700 [  0%]  (Warmup) 
Chain 1 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 2 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 4 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 3 Iteration: 201 / 700 [ 28%]  (Sampling) 
Chain 1 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 1 finished in 137.8 seconds.
Chain 4 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 2 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 4 finished in 145.7 seconds.
Chain 2 finished in 145.9 seconds.
Chain 3 Iteration: 700 / 700 [100%]  (Sampling) 
Chain 3 finished in 146.8 seconds.

All 4 chains finished successfully.
Mean chain execution time: 144.0 seconds.
Total execution time: 147.0 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>resumen_mod <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, mean, q5, q95)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>resumen_mod</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 45 × 4
   variable         mean          q5         q95
   &lt;chr&gt;           &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
 1 lp__      -13086.     -13092.     -13081.    
 2 beta_0        -0.382      -0.433      -0.330 
 3 beta[1,1]      0.705      -0.0265      1.37  
 4 beta[2,1]     -0.645      -1.32        0.0387
 5 beta[1,2]      0.320      -0.403       0.977 
 6 beta[2,2]     -2.06       -2.76       -1.34  
 7 beta[1,3]     -0.225      -0.950       0.445 
 8 beta[2,3]      1.05        0.391       1.72  
 9 beta[1,4]      0.0247     -0.700       0.686 
10 beta[2,4]      0.595      -0.0583      1.26  
# … with 35 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>sims_contraste <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"contraste_m_h"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"contraste"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"nombre"</span>, <span class="st">"dept"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="at">extra =</span> <span class="st">"drop"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sims_contraste, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> dept)) <span class="sc">+</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Donde vemos que los departamentos varían en la diferencia de aceptación de hombres y mujeres. Si resumimos con la marginal de los departamentos seleccionados, obtenemos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>sims_contraste_d <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"contraste_directo"</span>, <span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sims_contraste_d, <span class="fu">aes</span>(<span class="at">x =</span> contraste_directo)) <span class="sc">+</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>El efecto directo no es conclusivo, y tiende a favorecer a mujeres cuando promediamos sobre la distribución de departamentos seleccionados.</p>
<p>En algún momento de la discusión, este argumento fue mostrado para decir que no había discriminación en Berkeley específicamente orientado hacia las mujeres, aún cuando quedaba por investigar por qué el contraste de tasas de aceptación es tan diferente en cada departamento (puede haber muchas razones). Sin embargo, otros investigadores apuntaron al hecho de que la selección de departamentos y la tasa de aceptación puede tener una causa común: por ejemplo, la habilidad general.</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="st">    G</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="st">    D</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="st">    A </span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="st">    U</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a><span class="st">    G -&gt; D</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a><span class="st">    G -&gt; A</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a><span class="st">    D -&gt; A</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; D</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; A</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a><span class="st">{rank = same; G;A}</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a><span class="st">{rank = same; U}</span></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-add8f6d49fa795cf39cb" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-add8f6d49fa795cf39cb">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape=plaintext]\n    G\n    D\n    A \n  node [shape = circle]\n    U\n  edge [minlen = 3]\n    G -> D\n    G -> A\n    D -> A\n    U -> D\n    U -> A\n{rank = same; G;A}\n{rank = same; U}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Mediación con variables confusoras
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si existen variables confusoras entre la variable <span class="math inline">\(D\)</span> que media el efecto de otra variable y el resultado <span class="math inline">\(A\)</span>, <span class="math inline">\(D\)</span> se convierte en un colisionador. Cuando condicionamos a <span class="math inline">\(D\)</span> para estimar el efecto directo (que es un <strong>colisionador</strong>), activamos una ruta no causal entre <span class="math inline">\(G\)</span> y <span class="math inline">\(A\)</span> que va a través de <span class="math inline">\(U\)</span>. En este caso, el efecto directo no está identificado.</p>
</div>
</div>
<p>Aunque podemos calcular el efecto total de género sobre admisión, no es posible extraer en este caso el efecto directo. Por ejemplo (McElreath), una hipótesis que se ha planteado es la siguiente:</p>
<ul>
<li>Supongamos que existen departamentos que se sabe que discriminan o tienen prácticas discriminatorias. Las personas que aplican a esos departamentos que son suceptibles a esta discriminación tienden a ser personas de mayor habilidad que el aplicante típico, pues sólo en ese caso están dispuestas a sufrir tal discriminación. Esto implica que también su tasa de aceptación sin discriminación sería más alta por su mayor habilidad, pero en los datos no lo vemos. En este caso, puede haber discriminación directa que acaba enmascarada por esa autoselección.</li>
</ul>
<p>En este caso no tenemos la variable de habilidad, pero podríamos hacer análisis de sensibilidad. En el siguiente modelo, consideramos <em>hipotéticamente</em> qué pasaría si en el departamento 2 tuviera la imagen (justificada o no) de ser un ambiente discriminatorio para mujeres:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>mod_3_berkeley <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"../src/berkeley-3.stan"</span>)</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_3_berkeley)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; n_d;
  array[N] int admit;
  array[N] int gender;
  array[N] int dept;
  vector[2] delta;
  matrix[2, 6] eta;
}
transformed data {
  array[N] int gender_ind;

  for(i in 1:N){
    gender_ind[i] = 0;
    if(gender[i] == 2) {
      gender_ind[i] = 1;
    }
  }
}

parameters {
  real beta_0;
  array[2] vector[n_d] beta;
  matrix[2, n_d] alpha;
  vector[N] u; // habilidad latente
}


model {
  for(i in 1:N){
    // la variable u influye en la tasa de aceptación
    admit[i] ~ bernoulli_logit(alpha[gender[i], dept[i]] + delta[gender[i]] * u[i]);
    // la variable u influye en la eleccion de departamento
    dept[i] ~ categorical_logit(beta[gender[i]] + to_vector(eta[gender[i]]) * u[i]);
  }
  gender_ind ~ bernoulli_logit(beta_0);
  beta_0 ~ normal(0, 0.5);
  for(i in 1:2){
    beta[i] ~ normal(0, 1);
    alpha[i] ~ normal(0, 1);
  }
  u ~ normal(0, 1);
}

generated quantities{
  array[n_d] real contraste_m_h;
  real contraste_directo;
  array[n_d] real admit_prob_mujer;
  array[n_d] real admit_prob_hombre;

  // simulaciones para un aplicante promedio
  for(k in 1:n_d){
    int gender_do = 2;
    array[1000] real admit_prob_mujer_ind;
    for(j in 1:1000){
      admit_prob_mujer_ind[j] = bernoulli_logit_rng(alpha[gender_do, k]);
    }
    admit_prob_mujer[k] = mean(admit_prob_mujer_ind);

    gender_do = 1;
    array[1000] real admit_prob_hombre_ind;
    for(j in 1:1000){
      admit_prob_hombre_ind[j] = bernoulli_logit_rng(alpha[gender_do, k]);
    }
    admit_prob_hombre[k] = mean(admit_prob_hombre_ind);

  contraste_m_h[k] = admit_prob_mujer[k] - admit_prob_hombre[k];
  }

  contraste_directo = mean(contraste_m_h[dept]);

}</code></pre>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Variables latentes
</div>
</div>
<div class="callout-body-container callout-body">
<p>En este modelo, <span class="math inline">\(u\)</span> es una variable a nivel individuo. No conocemos su valor pero influye en <span class="math inline">\(D\)</span> y <span class="math inline">\(A\)</span> directamente. Si sabemos algo de la naturaleza de esta influencia, es posible extraer informacion acerca de los valores <span class="math inline">\(u\)</span> de cada individuo.</p>
<p>Desde el punto de vista bayesiano, los valores que toma esta variable son parámetros a estimar.</p>
</div>
</div>
<p>Por ejemplo, si una mujer es aceptada a un departamento que aparenta actividades descriminatorias, por las razones explicadas arriba podemos deducir que su nivel de habilidad es en general mayor que el aplicantes hombres, y eso puede explicar por qué aún cuando las tasas de aceptación el departamento sean similares, existe una componente de discriminación “estructural”.</p>
<p>En este ejercicio haremos un análisis de sensibilidad de nuestras hipótesis. Supondremos que los niveles de habilidad en general ayudan a entrar en cualquier departamente, pero que la probabilidad de que una mujer aplique a un departamento discriminatorio sólo es alta si su nivel de habilidad es alto (ver los variables delta y eta en el siguiente modelo):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(adm_indiv), <span class="at">n_d =</span> <span class="dv">6</span>,</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">admit =</span> adm_indiv<span class="sc">$</span>Admit, <span class="at">gender =</span> adm_indiv<span class="sc">$</span>Gender,</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dept =</span> adm_indiv<span class="sc">$</span>Dept)</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="do">## incluimos coeficientes fijos para la relación de habilidad</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="do">## con selección de departamente y adimisión</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>datos_lista <span class="ot">&lt;-</span> <span class="fu">c</span>(datos_lista,</span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#habilidad ayuda en todos los departamentos</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">delta =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#pero los de habilidad alta intentan a aplicar al departamento 2.</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>)), <span class="at">nrow=</span> <span class="dv">2</span>, <span class="at">byrow =</span> T))</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>ajuste_disc <span class="ot">&lt;-</span> mod_3_berkeley<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lista, </span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">iter_warmup =</span> <span class="dv">300</span>, <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">refresh =</span> <span class="dv">1000</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 1300 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 1300 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 1300 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 1300 [  0%]  (Warmup) 
Chain 1 Iteration:  301 / 1300 [ 23%]  (Sampling) 
Chain 4 Iteration:  301 / 1300 [ 23%]  (Sampling) 
Chain 3 Iteration:  301 / 1300 [ 23%]  (Sampling) 
Chain 2 Iteration:  301 / 1300 [ 23%]  (Sampling) 
Chain 1 Iteration: 1300 / 1300 [100%]  (Sampling) 
Chain 1 finished in 568.0 seconds.
Chain 3 Iteration: 1300 / 1300 [100%]  (Sampling) 
Chain 3 finished in 569.6 seconds.
Chain 4 Iteration: 1300 / 1300 [100%]  (Sampling) 
Chain 4 finished in 570.0 seconds.
Chain 2 Iteration: 1300 / 1300 [100%]  (Sampling) 
Chain 2 finished in 577.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 571.2 seconds.
Total execution time: 577.4 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>resumen_disc_mod <span class="ot">&lt;-</span> ajuste_disc<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, mean, q5, q95)</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>resumen_disc_mod</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,571 × 4
   variable         mean          q5        q95
   &lt;chr&gt;           &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;
 1 lp__      -14726.     -14805.     -14647    
 2 beta_0        -0.382      -0.431      -0.332
 3 beta[1,1]      0.702       0.0495      1.36 
 4 beta[2,1]     -0.531      -1.22        0.140
 5 beta[1,2]      0.315      -0.321       0.984
 6 beta[2,2]     -1.94       -2.67       -1.25 
 7 beta[1,3]     -0.230      -0.882       0.435
 8 beta[2,3]      1.17        0.485       1.84 
 9 beta[1,4]      0.0196     -0.637       0.686
10 beta[2,4]      0.711       0.0254      1.37 
# … with 4,561 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>sims_contraste_disc <span class="ot">&lt;-</span> ajuste_disc<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"contraste_m_h"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"contraste"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"nombre"</span>, <span class="st">"dept"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="at">extra =</span> <span class="st">"drop"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>sims_2 <span class="ot">&lt;-</span> sims_contraste_disc <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="st">"Con habilidad (hipotético)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(sims_contraste <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="st">"Ingorando habilidad"</span>))</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sims_2, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> dept)) <span class="sc">+</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span> tipo, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-modelos-causales_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Notamos que los resultados para el “departamento discriminatorio” efectivamente indica un efecto directo más grande que favorece a hombres. Nótese como en este ejemplo el efecto de selección de departamento para mujeres es relativamente fuerte (alta habilidad tiende a ir a departamento 5), los efectos para el resto de los departamentos son contrarios: algunos se mueven a la derecha, es decir, parece haber má ventaja para mujeres. Esto es porque el departamento 5 absorbe a la mayoría de mujeres de habilidad alta, lo que implica que la habilidad promedio de mujeres en otros departamentos es más baja que la de los hombres.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Análisis de sensibilidad
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si existe la posibilidad de variables confusoras, podemos hacer ejericicios de modelación/simulación para estimar qué tan fuertes tendría que ser la relación de la variable confusora para producir resultados que cambien nuestras conclusiones.</p>
</div>
</div>
</section>
<section id="ejemplo-burks-pearl" class="level3" data-number="3.11.2">
<h3 data-number="3.11.2" class="anchored" data-anchor-id="ejemplo-burks-pearl"><span class="header-section-number">3.11.2</span> Ejemplo (Burks, Pearl)</h3>
<p>Este ejemplo es mencionado por Pearl en The Book of Why. En 1926 Burks recolectó datos sobre qué tanto podría esperarse que la inteligencia de padres se hereda a los hijos (medido según una prueba de IQ). Construyó un diagrama parecido al de abajo:</p>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2]</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="st">    U</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a><span class="st">    IntPadres -&gt; NSE</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a><span class="st">    NSE -&gt; IntHijos</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; NSE</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a><span class="st">    U -&gt; IntHijos</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a><span class="st">    IntPadres -&gt; IntHijos</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a><span class="st">{rank = same; U}</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-cbbc86de9082c9a7e72e" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-cbbc86de9082c9a7e72e">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape = circle]\n    U\n  node [shape=plaintext]\n  edge [minlen = 3]\n    IntPadres -> NSE\n    NSE -> IntHijos\n    U -> NSE\n    U -> IntHijos\n    IntPadres -> IntHijos\n{rank = same; U}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Como el NSE es del hogar (una medida general de estatus social), se consideró en principio como una variable pre-tratamiento a la inteligencia de los niños por la que tradicionalmente se controlaba. Burks notó que hacer esto tenía como consecuencia cortar parte del efecto total de la inteligencia sobre el la inteligencia de los hijos. Adicionalmente, condicionar a NSE abre un camino no causal entre Inteligencia de Padres e Hijos.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-rethinking" class="csl-entry" role="doc-biblioentry">
McElreath, Richard. 2015. <em>Statistical Rethinking, A Course in R and Stan</em>. <a href="http://xcelab.net/rmpubs/rethinking/Statistical_Rethinking_sample.pdf">http://xcelab.net/rmpubs/rethinking/Statistical_Rethinking_sample.pdf</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02-modelos-graficos.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Modelos gráficos probabilísticos</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./99-referencias.html" class="pagination-link">
        <span class="nav-page-text">Referencias</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>